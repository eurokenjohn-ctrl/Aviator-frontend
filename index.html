<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Swiftcrash - The ultimate crash game experience. Play, win, and earn KSH 300 per referral!">
  <meta name="keywords" content="Swiftcrash, crash game, aviator, betting, online game, earn money, referral">
  <meta name="author" content="Swiftcrash">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#f97316">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://swiftcrash.com/">
  <meta property="og:title" content="Swiftcrash">
  <meta property="og:description" content="Swiftcrash - The ultimate crash game experience. Play, win, and earn KSH 300 per referral!">
  <meta property="og:image" content="aviator.png">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://swiftcrash.com/">
  <meta property="twitter:title" content="Swiftcrash">
  <meta property="twitter:description" content="Swiftcrash - The ultimate crash game experience. Play, win, and earn KSH 300 per referral!">
  <meta property="twitter:image" content="aviator.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="aviator.png">
  <link rel="apple-touch-icon" href="aviator.png">
  <title>Swiftcrash</title>
  <style>
    body { background-color: #09090b; color: white; font-family: sans-serif; margin: 0; padding-bottom: 60px; }
    
    /* Top Bar */
    .top-bar { background-color: #f97316; padding: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: bold; }
    .btn-share { background-color: white; color: #f97316; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 12px; cursor: pointer; }
    
    /* Header */
    .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f2937; background: #111827; }
    .logo { color: #f59e0b; font-size: 20px; font-weight: 900; display: flex; align-items: center; gap: 5px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn-deposit { background-color: #22c55e; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; display: none; }
    .btn-withdraw { background-color: #f59e0b; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; display: none; margin-top: 5px; }
    .btn-login-header { background-color: #3b82f6; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; }
    .balance { font-weight: bold; font-size: 14px; color: #22c55e; display: none; }
    .profile-icon { background: #374151; padding: 5px 10px; border-radius: 50%; cursor: pointer; display: none; }

    /* Odds History */
    .odds-history { display: flex; gap: 5px; padding: 10px; overflow-x: auto; background: #111827; white-space: nowrap; }
    .odd { background: #1f2937; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    
    /* Aviator Area */
    .aviator-box { margin: 10px; border-radius: 10px; overflow: hidden; background: repeating-conic-gradient(from 0deg, #111 0deg 15deg, #1a1a1a 15deg 30deg); position: relative; height: 250px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .jackpot-banner { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #b45309, #f59e0b); text-align: center; padding: 5px; font-weight: bold; font-size: 12px; }
    .multiplier-display { font-size: 48px; font-weight: bold; color: white; z-index: 10; text-shadow: 0px 0px 10px rgba(0,0,0,0.8); }
    .plane { position: absolute; top: 0; left: 0; width: 60px; height: 30px; margin-top:-15px; margin-left:-30px; z-index: 3; display: none; transition: transform 0.05s linear; }
    .flew-away-text { color: #ef4444; font-size: 24px; font-weight: bold; display: none; margin-top: 10px; }
    
    /* Toggle Tabs */
    .bet-tabs { display: flex; background: #1f2937; border-radius: 20px; padding: 4px; margin-bottom: 10px; width: 100%; max-width: 200px; margin-left: auto; margin-right: auto; }
    .bet-tab { flex: 1; padding: 6px; text-align: center; color: #9ca3af; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 16px; transition: 0.2s; }
    .bet-tab.active { background: #374151; color: white; }

    /* Controls */
    .controls { padding: 15px; display: grid; gap: 10px; }
    .auto-cashout { display: flex; justify-content: space-between; align-items: center; background: #1f2937; padding: 10px; border-radius: 8px; }
    .auto-input { background: #111827; border: 1px solid #374151; color: white; text-align: right; width: 60px; font-size: 16px; padding: 5px; border-radius: 4px; }
    .bet-amount { display: flex; align-items: center; background: #1f2937; border-radius: 8px; overflow: hidden; }
    .bet-btn-adjust { background: #374151; border: none; color: white; padding: 15px 20px; font-size: 18px; cursor: pointer; }
    .bet-input { flex: 1; background: transparent; border: none; color: white; text-align: center; font-size: 18px; font-weight: bold; }
    .bet-presets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
    .preset { background: #1f2937; border: none; color: white; padding: 10px 0; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-big-bet { background: #22c55e; color: white; border: none; padding: 20px; border-radius: 8px; font-size: 20px; font-weight: bold; width: 100%; cursor: pointer; transition: 0.2s; }
    .btn-big-login { background: #3b82f6; color: white; border: none; padding: 20px; border-radius: 8px; font-size: 20px; font-weight: bold; width: 100%; cursor: pointer; display: none; }
    .btn-cashout { background: #eab308; color: #000; display: none; }
    .btn-cancel { background: #ef4444; color: white; display: none; }

    /* Share Dropdown */
    .share-dropdown { display: none; background: #1f2937; padding: 15px; border-bottom: 1px solid #374151; }
    .share-link-box { background: #111827; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    .social-share { display: flex; gap: 10px; margin-top: 15px; }
    .social-btn { padding: 8px 15px; border-radius: 5px; color: white; text-decoration: none; font-size: 12px; text-align: center; flex: 1; }

    /* Footer */
    .footer { position: fixed; bottom: 0; width: 100%; background: #111827; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #1f2937; z-index: 10; }
    .footer a { color: #9ca3af; text-decoration: none; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
    .footer a.active { color: #ef4444; }

    /* Popups */
    .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .popup-content { background: #111827; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937; }
    .profile-card { background: #1f2937; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #374151; }
    .profile-card h4 { margin: 0; font-size: 16px; color: #fff; }
    .profile-card p { margin: 0; color: #9ca3af; font-size: 14px; }
    .profile-input-box { background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 12px; color: white; width: 100%; box-sizing: border-box; }
    .profile-action-btn { display: flex; justify-content: space-between; align-items: center; background: #1f2937; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 1px solid #374151; }
    .profile-action-btn:hover { background: #374151; }
    .profile-action-info h4 { margin: 0; font-size: 16px; color: white; }
    .profile-action-info p { margin: 0; font-size: 12px; color: #9ca3af; }
    .exit-btn { display: flex; align-items: center; gap: 10px; background: #1f2937; padding: 15px; border-radius: 10px; cursor: pointer; color: #ef4444; border: 1px solid #374151; width: 100%; box-sizing: border-box; font-weight: bold; }
    .support-section { margin-top: 20px; }
    .support-section h4 { margin-bottom: 10px; color: #fff; }
    .support-icons { display: flex; gap: 15px; }
    .support-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; }
    .popup-close { position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #9ca3af; }
    .form-control { width: 100%; padding: 10px; background: #111827; border: 1px solid #374151; color: white; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { width: 100%; padding: 12px; background: #e11d48; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .switch-auth { color: #3b82f6; cursor: pointer; text-align: center; display: block; margin-top: 15px; font-size: 14px; }
    .error-msg { color: #ef4444; font-size: 12px; margin-top: 5px; display: none; }
    .success-msg { color: #22c55e; font-size: 14px; text-align: center; margin-top: 10px; display: none; }
    
    .spinner { display: none; margin: 10px auto; border: 4px solid rgba(255,255,255,0.1); border-left-color: #f97316; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); } 100% { transform: scale(1); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); } }
    @keyframes glow { 0%, 100% { text-shadow: 0 0 5px rgba(245, 158, 11, 0.5), 0 0 10px rgba(245, 158, 11, 0.3); } 50% { text-shadow: 0 0 15px rgba(245, 158, 11, 0.9), 0 0 25px rgba(245, 158, 11, 0.6); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-logo { animation: glow 2s ease-in-out infinite, float 3s ease-in-out infinite; display: inline-flex; align-items: center; }
    .loading-glow { position: relative; }
    .loading-glow::after { content: ''; position: absolute; inset: -20px; background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%); z-index: -1; animation: pulse 3s infinite; }
    
    /* Advanced Spinner */
    .advanced-spinner {
      width: 50px;
      height: 50px;
      display: inline-block;
      position: relative;
    }
    .advanced-spinner::after, .advanced-spinner::before {
      content: '';  
      box-sizing: border-box;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid #f59e0b;
      position: absolute;
      left: 0;
      top: 0;
      animation: animloader 2s linear infinite;
    }
    .advanced-spinner::after {
      animation-delay: 1s;
    }
    @keyframes animloader {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    /* Switch toggle */
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Hide number input arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* Notification Bell */
    .notification-bell { position: relative; cursor: pointer; display: none; }
    .notification-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    .notification-item { background: #1f2937; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 13px; border-left: 3px solid #3b82f6; }
    .notification-item.unread { background: #1e293b; border-left-color: #f59e0b; }
    .notification-time { font-size: 10px; color: #9ca3af; margin-top: 5px; }

    /* Custom Toast Notifications */
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
    .toast-msg { padding: 15px 20px; border-radius: 8px; font-weight: bold; font-size: 14px; text-align: center; color: white; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: auto; }
    .toast-msg.show { opacity: 1; transform: translateY(0); }
    .toast-success { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .toast-error { background: linear-gradient(135deg, #dc2626, #ef4444); }

  </style>
</head>
<body>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" style="position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <div class="loading-glow">
      <h1 class="logo animate-logo" style="font-size: 36px; margin-bottom: 30px;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="48" height="48" style="margin-right: 12px; filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.6));">
          <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-.5-.5-2.5 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.2-1.1.6L3 8l6.2 3.8L6.5 14 3.8 13c-.4-.1-.8.2-1 .5L2 14.5l4.5 3 3 4.5 1-1c.3-.2.6-.6.5-1L10 17.5l2.2-2.7 8.2 6.2c.4.3.8-.1.7-.5l-1.2-4.3z"/>
        </svg>
        Swiftcrash
      </h1>
    </div>
    
    <div id="advancedLoader" style="display: none; margin-bottom: 20px;">
      <span class="advanced-spinner"></span>
    </div>

    <div id="progressContainer" style="width: 220px; height: 6px; background: #1f2937; border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);">
      <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); transition: width 0.1s; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);"></div>
    </div>
    <p id="loadingText" style="margin-top: 15px; color: #9ca3af; font-size: 14px; font-weight: 500; letter-spacing: 0.5px;">Initializing game engine...</p>
  </div>

  <!-- Top Bar -->
  <div class="top-bar">
    <span>üéÅ Earn KSH 300.00 per referral</span>
    <span class="btn-share" id="topActionBtn" onclick="handleTopAction()">Join Now</span>
  </div>

  <!-- Share Dropdown -->
  <div class="share-dropdown" id="shareDropdown">
    <h3 style="margin-top:0;">Refer a Friend</h3>
    <p style="font-size:14px; color:#d1d5db;">You earn KSH 300 when your friend makes a qualifying deposit.</p>
    <div class="share-link-box">
      <span id="referralLinkText" style="font-size:12px; word-break: break-all;">https://swiftcrash.com/?ref=xxxx</span>
      <button style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="copyReferral()">Copy</button>
    </div>
    <div class="social-share">
      <a href="#" class="social-btn" id="waShare" style="background:#25D366;" target="_blank">WhatsApp</a>
      <a href="#" class="social-btn" id="fbShare" style="background:#1877F2;" target="_blank">Facebook</a>
      <a href="#" class="social-btn" id="twShare" style="background:#1DA1F2;" target="_blank">Twitter</a>
    </div>
    <div id="referredByContainer" style="margin-top: 15px; font-size: 14px; display: none;">
      REFERRED BY: <span id="referredByUsername" style="color: #f59e0b; font-weight: bold;"></span>
    </div>
    <button style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); text-transform: uppercase; animation: pulse 2s infinite;" onclick="openReferralHistory()">REFERRAL HISTORY</button>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="logo"><span style="color:#facc15"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-.5-.5-2.5 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.2-1.1.6L3 8l6.2 3.8L6.5 14 3.8 13c-.4-.1-.8.2-1 .5L2 14.5l4.5 3 3 4.5 1-1c.3-.2.6-.6.5-1L10 17.5l2.2-2.7 8.2 6.2c.4.3.8-.1.7-.5l-1.2-4.3z"/></svg></span> Swiftcrash</div>
    <div class="header-actions">
      <button class="btn-login-header" id="headerLoginBtn" onclick="openAuth('login')">Login</button>
      <div class="balance" id="headerBalance" style="display:none; align-items:center; gap:5px;">
        <span id="balanceText">KSH 0.00</span>
        <svg id="refreshIcon" onclick="manualRefresh()" style="cursor:pointer; transition: transform 0.5s;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21v-5h5"/></svg>
      </div>
      <div id="hamburgerMenuIcon" style="display:none; cursor:pointer; margin-left:10px;" onclick="toggleHamburger()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </div>
    </div>
  </div>

  <div id="hamburgerDropdown" style="display:none; background:#1f2937; position:absolute; right:10px; top:75px; z-index:100; border-radius:8px; padding:10px; box-shadow:0 4px 6px rgba(0,0,0,0.3); border:1px solid #374151; min-width:150px;">
      <button class="btn-deposit" id="headerDepositBtn" style="width:100%; margin-bottom:5px; display:block;" onclick="openDeposit(); toggleHamburger();">+ DEPOSIT</button>
      <button class="btn-withdraw" id="headerWithdrawBtn" style="width:100%; margin-bottom:10px; display:block;" onclick="openWithdraw(); toggleHamburger();">- WITHDRAW</button>
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer; font-size:14px;" onclick="openNotifications(); toggleHamburger();">
        <span>Notifications</span>
        <div class="notification-bell" id="notificationBell" style="display:block;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <div class="notification-badge" id="notificationBadge" style="display:none;">0</div>
        </div>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer; font-size:14px;" onclick="openProfilePopup(); toggleHamburger();">
        <span>Profile</span>
        <div class="profile-icon" id="profileIcon" style="display:block; background:none; padding:0;">üë§</div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-top:1px solid #374151; padding-top:10px; font-size:14px;">
        <span>Sound</span>
        <label class="switch" style="transform: scale(0.8); margin:0;">
          <input type="checkbox" id="soundSwitch" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #374151; padding-top:10px; font-size:14px;">
        <span>Dark Mode</span>
        <label class="switch" style="transform: scale(0.8); margin:0;">
          <input type="checkbox" id="darkModeSwitch" checked onchange="toggleDarkMode(this.checked)">
          <span class="slider"></span>
        </label>
      </div>
  </div>
  <script>
    function showNotification(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast-msg toast-${type}`;
      toast.innerText = message;
      container.appendChild(toast);
      
      // Trigger reflow for animation
      void toast.offsetWidth;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Override default alert
    window.alert = function(msg) {
      // Try to guess if it's an error from the message text
      const type = msg.toLowerCase().includes('fail') || msg.toLowerCase().includes('error') || msg.toLowerCase().includes('invalid') || msg.toLowerCase().includes('insufficient') ? 'error' : 'success';
      showNotification(msg, type);
    };

    let hamburgerTimeout;
    function toggleHamburger() {
      const drop = document.getElementById('hamburgerDropdown');
      const icon = document.getElementById('hamburgerMenuIcon');
      const hamburgerSVG = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>';
      const closeSVG = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
      
      if (drop.style.display === 'block') {
         drop.style.display = 'none';
         if (icon) icon.innerHTML = hamburgerSVG;
         clearTimeout(hamburgerTimeout);
      } else {
         drop.style.display = 'block';
         if (icon) icon.innerHTML = closeSVG;
         // close after 20 secs
         hamburgerTimeout = setTimeout(() => {
             drop.style.display = 'none';
             if (icon) icon.innerHTML = hamburgerSVG;
         }, 20000);
      }
    }
    
    // Close on clicking outside
    document.addEventListener('click', function(event) {
      const drop = document.getElementById('hamburgerDropdown');
      const icon = document.getElementById('hamburgerMenuIcon');
      const hamburgerSVG = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>';
      if (drop && icon && drop.style.display === 'block' && !drop.contains(event.target) && !icon.contains(event.target)) {
        drop.style.display = 'none';
        icon.innerHTML = hamburgerSVG;
        clearTimeout(hamburgerTimeout);
      }
    });

    function toggleDarkMode(isDark) {
      if(isDark) {
         document.body.style.backgroundColor = '#09090b';
         document.body.style.color = 'white';
      } else {
         document.body.style.backgroundColor = '#f3f4f6';
         document.body.style.color = 'black';
         // more styling could be added for fully comprehensive light mode
      }
    }
    
    let flyOsc = null;
    let flyGain = null;
    function playSound(type) {
      if(!document.getElementById('soundSwitch').checked) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        if (type === 'bet') {
          osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime);
          osc.frequency.setValueAtTime(1200, ctx.currentTime + 0.1);
          gain.gain.setValueAtTime(0, ctx.currentTime);
          gain.gain.linearRampToValueAtTime(0.5, ctx.currentTime + 0.05);
          gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
          gain.gain.linearRampToValueAtTime(0.5, ctx.currentTime + 0.15);
          gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
          osc.start(); osc.stop(ctx.currentTime + 0.2);
        } else if (type === 'cashout') {
          osc.type = 'square'; osc.frequency.setValueAtTime(1000, ctx.currentTime);
          osc.frequency.setValueAtTime(1500, ctx.currentTime + 0.05);
          gain.gain.setValueAtTime(0, ctx.currentTime);
          gain.gain.linearRampToValueAtTime(0.5, ctx.currentTime + 0.01);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
          osc.start(); osc.stop(ctx.currentTime + 0.4);
        } else if (type === 'fly') {
          osc.type = 'sawtooth'; osc.frequency.setValueAtTime(80, ctx.currentTime);
          osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 30);
          gain.gain.setValueAtTime(0, ctx.currentTime);
          gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.5);
          osc.start();
          flyOsc = osc;
          flyGain = gain;
        } else if (type === 'crash') {
          if (flyOsc) {
            try { flyOsc.stop(); } catch(e) {}
            flyOsc = null;
          }
          osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.5);
          gain.gain.setValueAtTime(0.1, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
          osc.start(); osc.stop(ctx.currentTime + 0.5);
        } else if (type === 'deposit') {
          osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(1600, ctx.currentTime + 0.3);
          gain.gain.setValueAtTime(0.5, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
          osc.start(); osc.stop(ctx.currentTime + 0.3);
        }
      } catch(e) {}
    }
    
    async function manualRefresh() {
       const icon = document.getElementById('refreshIcon');
       icon.style.transform = 'rotate(360deg)';
       await refreshBalanceSilently();
       setTimeout(() => icon.style.transform = 'rotate(0deg)', 500);
    }
  </script>

  <!-- Odds History -->
  <div class="odds-history" id="oddsHistory">
    <div class="odd" style="color: #ef4444;">1.17x</div>
    <div class="odd" style="color: #a855f7;">46.59x</div>
    <div class="odd" style="color: #8b5cf6;">8.02x</div>
    <div class="odd" style="color: #eab308;">14.72x</div>
    <div class="odd" style="color: #ef4444;">1.05x</div>
    <div class="odd" style="color: #22c55e;">2.50x</div>
  </div>

  <!-- Aviator Area -->
  <div class="aviator-box" id="aviatorBox">
    <div class="jackpot-banner">üèÜ DAILY JACKPOT 1500X</div>
    <div class="multiplier-display" id="multiplier">1.00x</div>
    <div class="flew-away-text" id="flewAwayText">FLEW AWAY!</div>
    
    <div id="countdownDisplay" style="display:none; text-align:center; position:absolute; z-index:4;">
      <div style="color:#ef4444; font-size:12px; font-weight:bold; letter-spacing:2px; margin-bottom:5px;">NEXT ROUND IN</div>
      <div id="countdownTimer" style="font-size:64px; font-weight:normal; color:white;">18</div>
      <div style="width:200px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; margin:0 auto; overflow:hidden;">
        <div style="width:100%; height:100%; background:#ef4444; transition: width 1s linear;" id="nextRoundFill"></div>
      </div>
    </div>
    <svg id="trailSvg" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; display:none;" preserveAspectRatio="none">
      <path id="trailPath" d="" fill="none" stroke="#ef4444" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    <div class="plane" id="plane">
      <!-- Modern Jet Icon -->
      <svg width="60" height="30" viewBox="0 0 512 512" fill="#ef4444" style="filter: drop-shadow(0px 4px 6px rgba(239, 68, 68, 0.6));" xmlns="http://www.w3.org/2000/svg">
        <path d="M498.4 121.2c-7.4-8.8-19.4-12.8-30.8-10.4L322.2 144.6l-149.6-96.8c-6.8-4.4-15.4-5.6-22.8-3.2-7.4 2.4-13.4 8.2-16 15.6l-32.8 91.2-64.8-14c-8.6-1.8-17.6 1.8-22.6 9-5 7.2-5 16.8 0 24l52 74-27.6 30.6c-5.8 6.4-7.4 15.8-4 23.8 3.4 8 11.2 13.2 19.8 13.2h28l46.2 60.4c5.8 7.6 14.8 12 24.4 12h32c10.4 0 19.8-5.6 25-14.8l46.6-83 176.4 38.2c1.2.2 2.4.4 3.6.4 10.4 0 20-5.4 25.2-14.4 5.4-9.4 5.2-20.8-.4-30L498.4 121.2z"/>
      </svg>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls" style="padding: 10px; background: #111827; border-radius: 12px; margin: 10px; margin-top: 0;">
    <!-- Top row: Tabs & Auto settings toggle -->
    <div style="display:flex; justify-content:center; align-items:center; position:relative; margin-bottom: 10px; background:#1f2937; padding:4px; border-radius:20px; width:100%; max-width:250px; margin-left:auto; margin-right:auto;">
      <div class="bet-tab active" id="tabManual" onclick="setBetMode('manual')" style="flex:1; text-align:center; padding:6px; font-size:14px; border-radius:16px; font-weight:bold; cursor:pointer;">Bet</div>
      <div class="bet-tab" id="tabAuto" onclick="setBetMode('auto')" style="flex:1; text-align:center; padding:6px; font-size:14px; border-radius:16px; font-weight:bold; cursor:pointer;">Auto</div>
      <div style="position:absolute; right: -40px; background:#1f2937; border-radius:8px; padding:6px; cursor:pointer; color:#22c55e;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
      </div>
    </div>

    <!-- Auto Settings (Hidden by default, styled compactly) -->
    <div id="autoSettingsGroup" style="display:none; background:#1f2937; padding:10px; border-radius:8px; margin-bottom:10px; flex-direction:column; gap:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:14px; font-weight:bold; color:white;">Auto Bet</span>
        <label class="switch">
          <input type="checkbox" id="autoBetSwitch">
          <span class="slider"></span>
        </label>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:14px; font-weight:bold; color:white;">Auto Cashout</span>
        <div style="display:flex; align-items:center; gap:10px;">
          <label class="switch">
            <input type="checkbox" id="autoSwitch">
            <span class="slider"></span>
          </label>
          <input type="number" class="auto-input" id="autoCashoutVal" value="2.00" min="2.00" step="0.1" style="width:60px; text-align:right; background:#111827; border:1px solid #374151; color:white; padding:5px; border-radius:4px;">
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div style="display:flex; gap:10px; height:100%;">
      <!-- Left side: Amount & Presets -->
      <div style="flex:1; display:flex; flex-direction:column; gap:5px;">
        <div class="bet-amount" style="background:#1f2937; border-radius:8px; display:flex; align-items:center;">
          <button class="bet-btn-adjust" onclick="adjustBet(-1)" style="padding:10px; background:transparent; font-size:20px; font-weight:normal; border:none; color:white; width:40px;">-</button>
          <input type="number" class="bet-input" id="betAmount" value="5.00" min="1" max="100000" style="flex:1; width:100%; font-size:16px; font-weight:bold; text-align:center; background:transparent; border:none; color:white;" oninput="updateBetButtonAmount()">
          <button class="bet-btn-adjust" onclick="adjustBet(1)" style="padding:10px; background:transparent; font-size:20px; font-weight:normal; border:none; color:white; width:40px;">+</button>
        </div>
        <div class="bet-presets" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
          <button class="preset" onclick="setBet(100)" style="background:#1f2937; border:none; color:white; padding:8px 0; border-radius:4px; font-size:12px;">100</button>
          <button class="preset" onclick="setBet(200)" style="background:#1f2937; border:none; color:white; padding:8px 0; border-radius:4px; font-size:12px;">200</button>
          <button class="preset" onclick="setBet(500)" style="background:#1f2937; border:none; color:white; padding:8px 0; border-radius:4px; font-size:12px;">500</button>
          <button class="preset" onclick="setBet(20000)" style="background:#1f2937; border:none; color:white; padding:8px 0; border-radius:4px; font-size:12px;">20,000</button>
        </div>
      </div>

      <!-- Right side: Bet Button -->
      <div style="flex:1; display:flex; flex-direction:column;">
        <button class="btn-big-login" id="mainLoginBtn" onclick="openAuth('login')" style="flex:1; margin:0; display:none; flex-direction:column; justify-content:center; align-items:center; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:20px; font-weight:bold; cursor:pointer;">
           LOGIN
        </button>
        <button class="btn-big-bet" id="betBtn" onclick="handleBetClick()" style="flex:1; margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#22c55e; color:white; border:none; border-radius:8px; cursor:pointer; min-height:80px;">
           <span style="font-size:22px; font-weight:normal;">Bet</span>
           <span id="betBtnAmount" style="font-size:16px; font-weight:normal;">5.00 KES</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Fake Stats Card -->
  <div class="fake-stats-card" style="margin: 10px; background: #111827; border-radius: 12px; padding: 15px; border: 1px solid #1f2937;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <div id="fakeAvatarsContainer" style="display: flex; align-items: center; position: relative; height: 32px; width: 80px;">
        <!-- Avatars will be injected here via JS -->
      </div>
      <div style="text-align: right;">
        <div id="fakeTotalWin" style="font-size: 24px; font-weight: bold; color: white;">0.00</div>
      </div>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #9ca3af; margin-bottom: 5px;">
      <div><span id="fakeTotalBets">0/0</span> Bets</div>
      <div>Total win KES</div>
    </div>
    <div style="width: 100%; height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden;">
      <div id="fakeProgressBar" style="width: 0%; height: 100%; background: #65a30d; transition: width 0.3s linear;"></div>
    </div>
  </div>

  <script>
    let fakeTotalBetsCount = 0;
    let fakeMaxBetsCount = 0;
    let fakeTotalWinAmount = 0.00;

    const fakeAvatarImages = [
      'av1.png', 'av2.png', 'av3.png', 'av4.png', 'av5.png',
      'av6.png', 'av7.png', 'av8.png', 'av9.png', 'av10.png'
    ];
    let currentFakeAvatars = [];

    function renderFakeAvatars() {
      const container = document.getElementById('fakeAvatarsContainer');
      if (!container) return;
      container.innerHTML = '';
      currentFakeAvatars.forEach((img, index) => {
        const imgEl = document.createElement('img');
        imgEl.src = img;
        imgEl.style.width = '32px';
        imgEl.style.height = '32px';
        imgEl.style.borderRadius = '50%';
        imgEl.style.border = '2px solid #22c55e';
        imgEl.style.position = 'absolute';
        imgEl.style.left = `${index * 18}px`;
        imgEl.style.zIndex = 10 - index;
        imgEl.style.objectFit = 'cover';
        imgEl.style.backgroundColor = '#1f2937';
        container.appendChild(imgEl);
      });
    }

    function resetFakeStats() {
      fakeTotalBetsCount = 0;
      fakeMaxBetsCount = Math.floor(Math.random() * 3000) + 2000;
      fakeTotalWinAmount = 0.00;
      
      currentFakeAvatars = [];
      if (Math.random() > 0.3) {
        currentFakeAvatars.push(fakeAvatarImages[Math.floor(Math.random() * fakeAvatarImages.length)]);
      }
      renderFakeAvatars();
      
      const betsEl = document.getElementById('fakeTotalBets');
      const winEl = document.getElementById('fakeTotalWin');
      const barEl = document.getElementById('fakeProgressBar');
      
      if(betsEl) betsEl.innerText = `${fakeTotalBetsCount}/${fakeMaxBetsCount}`;
      if(winEl) winEl.innerText = fakeTotalWinAmount.toFixed(2);
      if(barEl) barEl.style.width = '0%';
    }

    function updateFakeStats() {
      if (typeof gameState !== 'undefined' && gameState === 'RUNNING') {
        let newBets = Math.floor(Math.random() * 50) + 10;
        fakeTotalBetsCount += newBets;
        if (fakeTotalBetsCount > fakeMaxBetsCount) fakeTotalBetsCount = fakeMaxBetsCount;

        let winIncrease = (Math.random() * 5000) + 1000;
        fakeTotalWinAmount += winIncrease;

        let progressPercent = (fakeTotalBetsCount / fakeMaxBetsCount) * 100;

        const betsEl = document.getElementById('fakeTotalBets');
        const winEl = document.getElementById('fakeTotalWin');
        const barEl = document.getElementById('fakeProgressBar');

        if(betsEl) betsEl.innerText = `${fakeTotalBetsCount}/${fakeMaxBetsCount}`;
        if(winEl) winEl.innerText = fakeTotalWinAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if(barEl) barEl.style.width = `${progressPercent}%`;

        if (Math.random() > 0.7 && currentFakeAvatars.length > 4) {
          currentFakeAvatars.pop();
          renderFakeAvatars();
        }

      } else if (typeof gameState !== 'undefined' && gameState === 'WAITING') {
        if (fakeTotalBetsCount !== 0) {
            resetFakeStats();
        }

        if (Math.random() > 0.4 && currentFakeAvatars.length < 7) {
          const randomAv = fakeAvatarImages[Math.floor(Math.random() * fakeAvatarImages.length)];
          if (!currentFakeAvatars.includes(randomAv)) {
            currentFakeAvatars.push(randomAv);
            renderFakeAvatars();
          }
        }

      } else if (typeof gameState !== 'undefined' && gameState === 'CRASHED') {
        if (currentFakeAvatars.length > 1) {
          currentFakeAvatars = [currentFakeAvatars[0]];
          renderFakeAvatars();
        }
      }
    }

    resetFakeStats();
    setInterval(updateFakeStats, 300);
  </script>

  <!-- Footer -->
  <div class="footer">
    <a href="index.html" class="active">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 12h4"/><path d="M8 10v4"/><path d="M15 13h.01"/><path d="M18 11h.01"/></svg>
      Game
    </a>
    <a href="Bets.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
      Bets
    </a>
    <a href="Wallet.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a8 8 0 0 1-5 7.96V16a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v5.96A8 8 0 0 1 2 15V7"/><path d="M22 10.5v1.07a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V10.5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z"/></svg>
      Wallet
    </a>
    <div style="position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <a href="javascript:void(0)" onclick="document.getElementById('menuDropdown').style.display = document.getElementById('menuDropdown').style.display === 'block' ? 'none' : 'block'" style="display:flex; flex-direction:column; align-items:center; color:#9ca3af; text-decoration:none; font-size:12px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        Menu
      </a>
      <div id="menuDropdown" style="display:none; position:absolute; bottom:50px; right:0; background:#1f2937; border:1px solid #374151; border-radius:8px; width:120px; z-index:100; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        <a href="Menu.html" style="display:flex; align-items:center; padding:12px; color:white; text-decoration:none; border-bottom:1px solid #374151; font-size:14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>Full Menu</a>
        <a href="#" onclick="openAdmin(); document.getElementById('menuDropdown').style.display='none'" style="display:flex; align-items:center; padding:12px; color:white; text-decoration:none; font-size:14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Admin</a>
      </div>
    </div>
  </div>

  <!-- ADMIN POPUP -->
  <div class="popup-overlay" id="adminPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('adminPopup').style.display='none'">√ó</span>
      <h2 style="margin-top:0;">Admin Dashboard</h2>
      
      <div id="adminLogin">
        <div class="form-group">
          <label>Admin Password</label>
          <input type="password" class="form-control" id="adminPassword">
        </div>
        <button class="btn-submit" onclick="doAdminLogin()">Login</button>
      </div>


        <div id="adminPanel" style="display:none;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 10px; flex-wrap:wrap; gap:5px;">
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('stats')">Stats</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('users')">Users</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('tx')">Transactions</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('game')">Game Odds</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('notifications')">Send Notif</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0;" onclick="showAdminSection('adjust')">Adjust Bal</button>
           <button class="btn-submit" style="width: auto; padding: 5px 10px; font-size:12px; margin-top:0; background:#3b82f6;" onclick="showAdminSection('create')">+ User</button>
        </div>
        
        <div id="admin-create" style="display:none; margin-top:10px;">
           <div class="form-group">
             <label>New User Phone Number</label>
             <input type="text" class="form-control" id="adminCreatePhone" placeholder="254...">
           </div>
           <div class="form-group">
             <label>Username</label>
             <input type="text" class="form-control" id="adminCreateUser" placeholder="Username">
           </div>
           <div class="form-group">
             <label>PIN (6 digits)</label>
             <input type="password" class="form-control" id="adminCreatePin" placeholder="000000">
           </div>
           <div class="form-group">
             <label>Initial Balance (KSH)</label>
             <input type="number" class="form-control" id="adminCreateBal" placeholder="e.g. 100" value="0">
           </div>
           <button class="btn-submit" style="background:#3b82f6;" onclick="adminCreateAccount()">Create Account</button>
        </div>

        <div id="admin-adjust" style="display:none; margin-top:10px;">
           <div class="form-group">
             <label>User Phone Number</label>
             <input type="text" class="form-control" id="adminAdjustPhone" placeholder="Enter phone number">
           </div>
           <div class="form-group">
             <label>Amount (Use negative to reduce)</label>
             <input type="number" class="form-control" id="adminAdjustAmount" placeholder="e.g. 50 or -50">
           </div>
           <button class="btn-submit" onclick="adminAdjustByPhone()">Apply Adjustment</button>
        </div>
        
        <div id="admin-stats">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
            <div style="background:#1f2937; padding:15px; border-radius:8px; text-align:center;">
              <div style="color:#9ca3af; font-size:12px;">Total Users</div>
              <div id="statUsers" style="font-size:24px; font-weight:bold; color:white;">0</div>
            </div>
            <div style="background:#1f2937; padding:15px; border-radius:8px; text-align:center;">
              <div style="color:#9ca3af; font-size:12px;">Total Balance</div>
              <div id="statBalance" style="font-size:24px; font-weight:bold; color:#22c55e;">KSH 0</div>
            </div>
            <div style="background:#1f2937; padding:15px; border-radius:8px; text-align:center; grid-column: span 2;">
              <div style="color:#9ca3af; font-size:12px;">Total Bets Placed</div>
              <div id="statBets" style="font-size:24px; font-weight:bold; color:#eab308;">0</div>
            </div>
          </div>
        </div>

        <div id="admin-users" style="display:none; max-height:300px; overflow-y:auto; margin-top:10px;">
           <table style="width:100%; font-size:12px; border-collapse: collapse;">
             <thead><tr style="background:#374151; color:white; text-align:left;"><th>User</th><th>Phone</th><th>PIN</th><th>Bal</th><th>Actions</th></tr></thead>
             <tbody id="adminUsersTbody"></tbody>
           </table>
        </div>
        
        <div id="admin-tx" style="display:none; max-height:300px; overflow-y:auto; margin-top:10px;">
           <table style="width:100%; font-size:12px; border-collapse: collapse;">
             <thead><tr style="background:#374151; color:white; text-align:left;"><th>Phone</th><th>Type</th><th>Amt</th><th>Status</th></tr></thead>
             <tbody id="adminTxTbody"></tbody>
           </table>
        </div>
        
        <div id="admin-game" style="display:none; margin-top:10px;">
           <div class="form-group" style="margin-bottom:20px; border-bottom:1px solid #374151; padding-bottom:15px;">
             <label style="color:#eab308; font-weight:bold; font-size:14px; display:block; margin-bottom:10px;">Force Next Specific Multiplier</label>
             <label>Multiplier (e.g. 5.50)</label>
             <input type="number" step="0.01" class="form-control" id="adminNextOdd" placeholder="Enter multiplier">
             <button class="btn-submit" onclick="adminSetOdd()" style="margin-top:10px;">Set Next Odd</button>
             <p style="font-size:11px; color:#9ca3af; margin-top:5px;">If left blank, game generates random odds automatically.</p>
           </div>
           
           <div class="form-group">
             <label style="color:#3b82f6; font-weight:bold; font-size:14px; display:block; margin-bottom:10px;">Random Generator Boundaries</label>
             <div style="display:flex; gap:10px;">
               <div style="flex:1;">
                 <label>Min (e.g. 1.00)</label>
                 <input type="number" step="0.01" class="form-control" id="adminMinOdd" placeholder="1.00">
               </div>
               <div style="flex:1;">
                 <label>Max (e.g. 50.00)</label>
                 <input type="number" step="0.01" class="form-control" id="adminMaxOdd" placeholder="50.00">
               </div>
             </div>
             <button class="btn-submit" style="background:#3b82f6; margin-top:10px;" onclick="adminSetBounds()">Set Odds Boundaries</button>
           </div>
        </div>
        
        <div id="admin-notifications" style="display:none; margin-top:10px;">
           <div class="form-group">
             <label>Send To</label>
             <select class="form-control" id="adminNotifTarget">
               <option value="all">All Users</option>
               <option value="specific">Specific Phone Number</option>
             </select>
           </div>
           <div class="form-group" id="adminNotifPhoneGroup" style="display:none;">
             <label>Phone Number</label>
             <input type="text" class="form-control" id="adminNotifPhone" placeholder="254...">
           </div>
           <div class="form-group">
             <label>Message</label>
             <textarea class="form-control" id="adminNotifMessage" rows="3" placeholder="Enter notification message"></textarea>
           </div>
           <button class="btn-submit" onclick="adminSendNotification()">Send Notification</button>
        </div>
      </div>

    </div>
  </div>

  <!-- AUTH POPUP -->
  <div class="popup-overlay" id="authPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="closeAuth()">√ó</span>
      
      <!-- Login Form -->
      <div id="loginForm">
        <div style="background: linear-gradient(to right, #4c1d95, #7e22ce); color: white; padding: 20px; text-align: center; font-style: italic; font-weight: bold; border-radius: 8px; margin-bottom: 20px; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        WELCOME BACK<br><span style="font-size: 14px; opacity: 0.8; font-weight: normal; letter-spacing: 2px; font-style: normal;">BONUS</span>
        </div>
        <div class="form-group">
          <label>Phone Number (07xxx)</label>
          <div style="display:flex; background:#111827; border:1px solid #374151; border-radius:5px;">
            <span style="padding:10px; color:#9ca3af; border-right:1px solid #374151;">+254</span>
            <input type="text" class="form-control" style="border:none;" id="loginPhone" placeholder="07...">
          </div>
        </div>
        <div class="form-group">
          <label>PIN (6 digits)</label>
          <input type="password" class="form-control" id="loginPin" maxlength="6">
          <a href="#" style="font-size:12px; color:#3b82f6; float:right; margin-top:5px; text-decoration:none;" onclick="showForgotPin()">Forgot PIN?</a>
        </div>
        <div class="error-msg" id="loginError"></div>
        <div class="spinner" id="loginSpinner"></div>
        <button class="btn-submit" onclick="doLogin()">Log In</button>
        <span class="switch-auth" onclick="toggleAuthForm('signup')">Don't have an account? Sign Up</span>
      </div>

      <!-- Signup Form -->
      <div id="signupForm" style="display:none;">
        <div style="background: linear-gradient(to right, #4c1d95, #7e22ce); color: white; padding: 20px; text-align: center; font-style: italic; font-weight: bold; border-radius: 8px; margin-bottom: 20px; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        JOIN THE ACTION<br><span style="font-size: 14px; opacity: 0.8; font-weight: normal; letter-spacing: 2px; font-style: normal;">BONUS</span>
        </div>
        <div class="form-group">
          <label>Username (Letters/Numbers/Underscores)</label>
          <input type="text" class="form-control" id="signupUsername" placeholder="e.g. mark123" oninput="validateUsername()">
          <span id="usernameValMsg" style="font-size:10px; color:#ef4444; display:none;">Invalid characters</span>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <div style="display:flex; background:#111827; border:1px solid #374151; border-radius:5px;">
            <span style="padding:10px; color:#9ca3af; border-right:1px solid #374151;">+254</span>
            <input type="text" class="form-control" style="border:none;" id="signupPhone" placeholder="07...">
          </div>
        </div>
        <div class="form-group">
          <label>PIN (6 digits)</label>
          <input type="password" class="form-control" id="signupPin" maxlength="6">
        </div>
        <div class="form-group">
          <label>Confirm PIN</label>
          <input type="password" class="form-control" id="signupPinConfirm" maxlength="6">
        </div>
        <div class="form-group">
          <label>Referral Code (Optional)</label>
          <input type="text" class="form-control" id="signupRef">
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="termsCheck">
          <label style="margin:0;">I agree to Terms & Conditions</label>
        </div>
        <div class="error-msg" id="signupError"></div>
        <div class="success-msg" id="signupSuccess"></div>
        <div class="spinner" id="signupSpinner"></div>
        <button class="btn-submit" onclick="doSignup()">Sign Up</button>
        <span class="switch-auth" onclick="toggleAuthForm('login')">Already have an account? Log In</span>
      </div>

      <!-- Forgot PIN Form -->
      <div id="forgotForm" style="display:none;">
        <h2 style="margin-top:0;">Forgot Password</h2>
        <div class="success-msg" id="forgotPinDisplay" style="background:#064e3b; padding:10px; border-radius:5px; margin-bottom:10px; font-size:18px; font-weight:bold;"></div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="forgotUsername" placeholder="Enter username">
        </div>
        <div class="error-msg" id="forgotError"></div>
        <div class="spinner" id="forgotSpinner"></div>
        <button class="btn-submit" onclick="doForgotPin()">Get PIN</button>
        <span class="switch-auth" onclick="toggleAuthForm('login')">Back to Login</span>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS POPUP -->
  <div class="popup-overlay" id="notificationsPopup">
    <div class="popup-content" style="background:#111827; border: 1px solid #374151; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); padding: 0; overflow: hidden; max-width: 450px;">
      <div style="background: linear-gradient(90deg, #1f2937, #111827); padding: 15px 20px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          Notifications
        </h2>
        <span class="popup-close" onclick="closeNotifications()" style="position: static; font-size: 24px; color: #9ca3af; transition: color 0.2s; cursor: pointer;">√ó</span>
      </div>
      <div id="notificationsList" style="max-height:350px; overflow-y:auto; padding: 15px 20px; background: #0b0f19;">
        <p style="text-align:center; color:#9ca3af; font-size: 14px; padding: 20px 0;">No notifications yet</p>
      </div>
      <div style="padding: 15px 20px; border-top: 1px solid #374151; background: #1f2937;">
        <button class="btn-submit" onclick="markAllAsRead()" style="background:#3b82f6; margin-top:0; border-radius: 8px; font-weight: bold; transition: background 0.2s;">Mark All as Read</button>
      </div>
    </div>
  </div>

  <!-- DEPOSIT POPUP -->
  <div class="popup-overlay" id="depositPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('depositPopup').style.display='none'">√ó</span>
      <h2 style="margin-top:0;">Deposit via M-Pesa</h2>
      <div class="form-group">
        <label>M-Pesa Number</label>
        <input type="text" class="form-control" id="depositPhone" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Amount (Min KSH 1)</label>
        <input type="number" class="form-control" id="depositAmount" value="1" min="1">
      </div>
      <div class="bet-presets" style="margin-bottom:15px;">
        <button class="preset" onclick="document.getElementById('depositAmount').value=100">100</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=200">200</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=500">500</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=1000">1K</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=5000">5K</button>
      </div>
      <p style="font-size: 14px; color: #9ca3af; text-align:center;">Current Balance: <strong id="depositCurrentBalance" style="color:white;">KSH 0.00</strong></p>
      
      <div class="error-msg" id="depositError"></div>
      <div class="success-msg" id="depositSuccess"></div>
      <div class="spinner" id="depositSpinner"></div>
      <button class="btn-submit" id="submitDepositBtn" style="background:#22c55e;" onclick="submitDeposit()">Deposit</button>
    </div>
  </div>

  <!-- WITHDRAW POPUP -->
  <div class="popup-overlay" id="withdrawPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('withdrawPopup').style.display='none'">√ó</span>
      <h2 style="margin-top:0;">Withdraw to M-Pesa</h2>
      <div class="form-group">
        <label>M-Pesa Number</label>
        <input type="text" class="form-control" id="withdrawPhone" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Amount (Min KSH 100)</label>
        <input type="number" class="form-control" id="withdrawAmount" value="100" min="100">
      </div>
      <div class="bet-presets" style="margin-bottom:15px;">
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=100">100</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=500">500</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=1000">1K</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=2000">2K</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=5000">5K</button>
      </div>
      <p style="font-size: 14px; color: #9ca3af; text-align:center;">Current Balance: <strong id="withdrawCurrentBalance" style="color:white;">KSH 0.00</strong></p>
      
      <div class="error-msg" id="withdrawError"></div>
      <div class="success-msg" id="withdrawSuccess"></div>
      <div class="spinner" id="withdrawSpinner"></div>
      <button class="btn-submit" id="submitWithdrawBtn" style="background:#f59e0b;" onclick="submitWithdraw()">Withdraw</button>
    </div>
  </div>

  <!-- PROFILE POPUP -->
  <div class="popup-overlay" id="profilePopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('profilePopup').style.display='none'">√ó</span>
      
      <div class="profile-card">
        <h4>Phone Number</h4>
        <div class="profile-input-box" id="profilePhone">254xxx</div>
      </div>

      <div class="profile-card">
        <h4>Change Password</h4>
        <input type="password" class="profile-input-box" id="newPasswordInput" placeholder="New Password">
        <input type="password" class="profile-input-box" id="confirmPasswordInput" placeholder="Confirm Password">
        <button class="btn-submit" style="background:#3b82f6; margin-top: 5px;" onclick="submitQuickChangePassword()">Update Password</button>
      </div>

      <div class="profile-action-btn" onclick="openTransactions()">
        <div class="profile-action-info">
          <h4>Transactions</h4>
          <p>Operations that affected the change in balance</p>
        </div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#3b82f6"><path d="M12 1L9 12l12-3-12-3z"/></svg>
      </div>

      <div class="profile-action-btn" onclick="openDeleteAccount()">
        <div class="profile-action-info">
          <h4>Delete Account</h4>
          <p>Self Exclusion</p>
        </div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#3b82f6"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      </div>

      <button class="exit-btn" onclick="doLogout()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Exit
      </button>

      <div class="support-section">
        <h4>Support</h4>
        <div class="support-icons">
          <div class="support-icon" style="background:#3b82f6;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div>
          <div class="support-icon" style="background:#ef4444;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div>
          <div class="support-icon" style="background:#22c55e;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12c0 2.17.7 4.19 1.94 5.86L3 22l4.14-1.06C8.73 21.61 10.3 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2z"/></svg></div>
          <div class="support-icon" style="background:#f97316;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PIN POPUP -->
  <div class="popup-overlay" id="changePinPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('changePinPopup').style.display='none'; openProfilePopup();">√ó</span>
      <h2 style="margin-top:0;">Change PIN</h2>
      <div class="form-group">
        <label>Old PIN</label>
        <input type="password" class="form-control" id="oldPin" maxlength="6">
      </div>
      <div class="form-group">
        <label>New PIN (6 digits)</label>
        <input type="password" class="form-control" id="newPin" maxlength="6">
      </div>
      <div class="form-group">
        <label>Confirm New PIN</label>
        <input type="password" class="form-control" id="confirmNewPin" maxlength="6">
      </div>
      <div class="error-msg" id="changePinError"></div>
      <div class="success-msg" id="changePinSuccess"></div>
      <button class="btn-submit" onclick="submitChangePin()">Confirm New PIN</button>
    </div>
  </div>

  <!-- TRANSACTIONS POPUP -->
  <div class="popup-overlay" id="transactionsPopup">
    <div class="popup-content" style="max-width:500px;">
      <span class="popup-close" onclick="document.getElementById('transactionsPopup').style.display='none'; openProfilePopup();">√ó</span>
      <h2 style="margin-top:0;">My Transactions</h2>
      <div id="txListContainer" style="max-height:300px; overflow-y:auto; background:#111827; padding:10px; border-radius:5px;">
        <p style="text-align:center; color:#9ca3af;">Loading...</p>
      </div>
    </div>
  </div>

  <!-- DELETE ACCOUNT POPUP -->
  <div class="popup-overlay" id="deleteAccountPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('deleteAccountPopup').style.display='none'; openProfilePopup();">√ó</span>
      <h2 style="margin-top:0; color:#ef4444;">Delete Account</h2>
      <p style="font-size:12px; color:#9ca3af; margin-bottom:15px;">Warning: This action is permanent and cannot be undone.</p>
      <div class="form-group">
        <label>Username</label>
        <input type="text" class="form-control" id="deleteUsername" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Phone Number</label>
        <input type="text" class="form-control" id="deletePhone" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Enter PIN to Confirm</label>
        <input type="password" class="form-control" id="deletePin" maxlength="6">
      </div>
      <div class="error-msg" id="deleteError"></div>
      <button class="btn-submit" style="background:#ef4444;" onclick="submitDeleteAccount()">Delete My Account</button>
    </div>
  </div>

  <!-- Referral History Popup -->
  <div class="popup-overlay" id="referralHistoryPopup" onclick="if(event.target===this) closeReferralHistory()">
    <div class="popup-content">
      <span class="popup-close" onclick="closeReferralHistory()">√ó</span>
      <h2 style="margin-top:0;">Refer & Earn ‚ú®</h2>
      
      <div style="background: #16a34a; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 5px 0; color: white;">Earn KSH 20 & 5% Lifetime Commission!</h3>
        <p style="margin: 0; font-size: 14px; color: #dcfce7;">Earn KSH 20 instantly for each referred user.</p>
        <p style="margin: 5px 0 0 0; font-size: 12px; color: #dcfce7;">Plus, earn a massive 5% lifetime commission on every deposit your friend makes. Share your link and start earning today! üí∞</p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: center;">
        <div style="background: #1f2937; padding: 10px; border-radius: 8px;">
          <div style="font-size: 18px; font-weight: bold; color: white;" id="refCount">0</div>
          <div style="font-size: 10px; color: #9ca3af;">REFERRALS</div>
        </div>
        <div style="background: #1f2937; padding: 10px; border-radius: 8px;">
          <div style="font-size: 18px; font-weight: bold; color: #22c55e;" id="refActive">0</div>
          <div style="font-size: 10px; color: #9ca3af;">ACTIVE</div>
        </div>
        <div style="background: #1f2937; padding: 10px; border-radius: 8px;">
          <div style="font-size: 18px; font-weight: bold; color: #f59e0b;" id="refDeposits">0</div>
          <div style="font-size: 10px; color: #9ca3af;">DEPOSITS (KSH)</div>
        </div>
      </div>

      <div style="background: #1f2937; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div>
          <div style="font-size: 12px; color: #9ca3af;">Total Earned</div>
          <div style="font-size: 12px; color: #22c55e; font-weight: bold;">LIFETIME REWARDS</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 12px; color: #9ca3af;">KSH</div>
          <div style="font-size: 24px; font-weight: bold; color: white;" id="refEarned">0</div>
        </div>
      </div>
      
      <div id="referralsList" style="max-height: 150px; overflow-y: auto;">
        <div style="text-align:center; color:#9ca3af; font-size:12px; margin-top:20px;">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    // BACKEND CONFIGURATION
    const BACKEND_URL = "https://swiftaviator-server.onrender.com"; // Change to your live backend URL
    
    // REFERRAL LOGIC
    function checkUrlReferral() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref) {
        localStorage.setItem('swiftcrash_ref', ref);
      }
    }
    checkUrlReferral();

    async function openReferralHistory() {
      if(!currentUser) return;
      document.getElementById('referralHistoryPopup').style.display = 'flex';
      
      try {
        const res = await fetch(`${BACKEND_URL}/api/referrals?phone=${currentUser.phone}`);
        const data = await res.json();
        
        if (data.success) {
          document.getElementById('refCount').innerText = data.referrals.length;
          document.getElementById('refActive').innerText = data.active_referrals;
          document.getElementById('refDeposits').innerText = data.total_deposits;
          document.getElementById('refEarned').innerText = data.total_earned;
          
          const list = document.getElementById('referralsList');
          if (data.referrals.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#9ca3af; font-size:12px; margin-top:20px;">No referrals yet</div>';
          } else {
            list.innerHTML = data.referrals.map(r => `
              <div style="background:#111827; padding:10px; border-radius:5px; margin-bottom:5px; display:flex; justify-content:space-between;">
                <span style="color:white; font-size:14px;">${r.username}</span>
                <span style="color:#9ca3af; font-size:12px;">${new Date(r.created_at).toLocaleDateString()}</span>
              </div>
            `).join('');
          }
        }
      } catch(e) {
        document.getElementById('referralsList').innerHTML = '<div style="text-align:center; color:#ef4444; font-size:12px; margin-top:20px;">Error loading referrals</div>';
      }
    }

    function closeReferralHistory() {
      document.getElementById('referralHistoryPopup').style.display = 'none';
    }

    // PROFILE SCRIPTS
    function openProfilePopup() {
      if(!currentUser) return;
      document.getElementById('profilePhone').innerText = currentUser.phone;
      document.getElementById('profilePopup').style.display = 'flex';
    }

    async function submitQuickChangePassword() {
      const newPin = document.getElementById('newPasswordInput').value;
      const confirmPin = document.getElementById('confirmPasswordInput').value;
      
      if (!newPin || !confirmPin) { alert("Fill all fields"); return; }
      if (newPin !== confirmPin) { alert("Passwords do not match"); return; }
      if (newPin.length !== 6) { alert("PIN must be 6 digits"); return; }

      try {
        const res = await fetch(`${BACKEND_URL}/change-pin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone, oldPin: currentUser.pin, newPin })
        });
        const data = await res.json();
        if(data.success) {
          alert("Password updated successfully!");
          currentUser.pin = newPin;
          localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
          document.getElementById('newPasswordInput').value = '';
          document.getElementById('confirmPasswordInput').value = '';
        } else {
          alert(data.error || "Failed to update password");
        }
      } catch(e) { alert("Network error"); }
    }

    function openChangePin() {
      document.getElementById('profilePopup').style.display = 'none';
      document.getElementById('changePinError').style.display = 'none';
      document.getElementById('changePinSuccess').style.display = 'none';
      document.getElementById('oldPin').value = '';
      document.getElementById('newPin').value = '';
      document.getElementById('confirmNewPin').value = '';
      document.getElementById('changePinPopup').style.display = 'flex';
    }

    async function submitChangePin() {
      const oldPin = document.getElementById('oldPin').value;
      const newPin = document.getElementById('newPin').value;
      const confirmPin = document.getElementById('confirmNewPin').value;
      const errEl = document.getElementById('changePinError');
      const succEl = document.getElementById('changePinSuccess');
      
      errEl.style.display = 'none';
      succEl.style.display = 'none';

      if (!oldPin || !newPin || !confirmPin) { errEl.innerText = "Fill all fields"; errEl.style.display='block'; return; }
      if (newPin !== confirmPin) { errEl.innerText = "New PINs do not match"; errEl.style.display='block'; return; }
      if (newPin.length !== 6) { errEl.innerText = "PIN must be 6 digits"; errEl.style.display='block'; return; }

      try {
        const res = await fetch(`${BACKEND_URL}/change-pin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone, oldPin, newPin })
        });
        const data = await res.json();
        if(data.success) {
          succEl.innerText = "PIN changed successfully!";
          succEl.style.display = 'block';
          currentUser.pin = newPin;
          localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
          setTimeout(() => document.getElementById('changePinPopup').style.display='none', 1500);
        } else {
          errEl.innerText = data.error || "Failed to change PIN";
          errEl.style.display = 'block';
        }
      } catch(e) { errEl.innerText="Network error"; errEl.style.display='block'; }
    }

    async function openTransactions() {
      document.getElementById('profilePopup').style.display = 'none';
      document.getElementById('transactionsPopup').style.display = 'flex';
      const container = document.getElementById('txListContainer');
      container.innerHTML = '<p style="text-align:center; color:#9ca3af;">Loading...</p>';

      try {
        const res = await fetch(`${BACKEND_URL}/transactions-history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone })
        });
        const data = await res.json();
        if(data.success) {
          if(data.transactions.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#9ca3af;">No transactions found.</p>';
          } else {
            container.innerHTML = `<table style="width:100%; font-size:12px; border-collapse:collapse; text-align:left;">
              <thead><tr style="border-bottom:1px solid #374151; color:#9ca3af;">
                <th style="padding:5px;">Type</th><th style="padding:5px;">Amount</th><th style="padding:5px;">Status</th><th style="padding:5px;">Date</th>
              </tr></thead><tbody>` + 
              data.transactions.map(t => `
                <tr style="border-bottom:1px solid #1f2937;">
                  <td style="padding:8px; text-transform:capitalize; color:${t.type==='deposit'?'#22c55e':'#f59e0b'};">${t.type}</td>
                  <td style="padding:8px;">KSH ${parseFloat(t.amount).toFixed(2)}</td>
                  <td style="padding:8px;">${t.status}</td>
                  <td style="padding:8px;">${new Date(t.created_at).toLocaleString()}</td>
                </tr>
              `).join('') + `</tbody></table>`;
          }
        } else {
          container.innerHTML = `<p style="text-align:center; color:#ef4444;">Failed to load transactions</p>`;
        }
      } catch(e) { container.innerHTML = `<p style="text-align:center; color:#ef4444;">Network error</p>`; }
    }

    function doLogout() {
      localStorage.removeItem('swiftcrash_user');
      currentUser = null;
      document.getElementById('profilePopup').style.display = 'none';
      showNotification("Logged out successfully");
      initApp();
    }

    function openDeleteAccount() {
      document.getElementById('profilePopup').style.display = 'none';
      document.getElementById('deleteUsername').value = currentUser.username;
      document.getElementById('deletePhone').value = currentUser.phone;
      document.getElementById('deletePin').value = '';
      document.getElementById('deleteError').style.display = 'none';
      document.getElementById('deleteAccountPopup').style.display = 'flex';
    }

    async function submitDeleteAccount() {
      const pin = document.getElementById('deletePin').value;
      const errEl = document.getElementById('deleteError');
      errEl.style.display = 'none';

      if(!pin) { errEl.innerText="Please enter your PIN"; errEl.style.display='block'; return; }

      try {
        const res = await fetch(`${BACKEND_URL}/delete-account`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone, pin })
        });
        const data = await res.json();
        if(data.success) {
          showNotification("Account deleted successfully");
          document.getElementById('deleteAccountPopup').style.display = 'none';
          localStorage.removeItem('swiftcrash_user');
          currentUser = null;
          initApp();
        } else {
          errEl.innerText = data.error || "Failed to delete account";
          errEl.style.display = 'block';
        }
      } catch(e) { errEl.innerText="Network error"; errEl.style.display='block'; }
    }

    // STATE
    let currentUser = JSON.parse(localStorage.getItem('swiftcrash_user'));
    
    // GAME STATE
    let gameState = 'WAITING'; // WAITING, RUNNING, CRASHED
    let currentMultiplier = 1.00;
    let betStatus = 'NONE'; // NONE, PLACED, PLACED_WAITING, PROCESSING, ACTIVE, CASHOUT
    let activeBetAmount = 0;
    let currentBetId = null;
    let gameInterval, progressInterval, balanceInterval;

    setInterval(() => {
      if (currentUser && document.visibilityState === 'visible') {
        refreshBalanceSilently();
        fetchNotifications();
      }
    }, 10000); // Auto update balance and notifications every 10s

    // Loading Screen Logic
    window.onload = () => {
      let progress = 0;
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('loadingText');
      const progressContainer = document.getElementById('progressContainer');
      const advancedLoader = document.getElementById('advancedLoader');
      
      const interval = setInterval(() => {
        if (progress < 60) {
          progress += 4;
          bar.style.width = progress + '%';
        } else if (progress === 60) {
          clearInterval(interval);
          text.innerText = 'Connecting to server...';
          
          // Show advanced spinner when connecting
          if (progressContainer) progressContainer.style.display = 'none';
          if (advancedLoader) advancedLoader.style.display = 'block';
          
          // Ping the server to wake it up (solves Render cold start issue)
          fetch(`${BACKEND_URL}/`)
            .then(() => {
              // Server is awake, hide spinner and complete the loading bar
              if (advancedLoader) advancedLoader.style.display = 'none';
              if (progressContainer) progressContainer.style.display = 'block';
              
              const finishInterval = setInterval(() => {
                progress += 5;
                bar.style.width = progress + '%';
                if(progress >= 100) {
                  clearInterval(finishInterval);
                  text.innerText = 'Ready to Play!';
                  setTimeout(() => {
                    const screen = document.getElementById('loadingScreen');
                    screen.style.transition = 'opacity 0.5s';
                    screen.style.opacity = '0';
                    setTimeout(() => {
                      screen.style.display = 'none';
                      initApp();
                    }, 500);
                  }, 500);
                }
              }, 50);
            })
            .catch(err => {
              console.error("Server connection error", err);
              text.innerText = 'Server unavailable. Please refresh.';
            });
        }
      }, 80);
    };

    function initApp() {
      updateUIForAuth();
      if (currentUser) {
        refreshBalanceSilently();
      }
      startGameLoop();
    }

    // AUTH UI UPDATES
    function updateUIForAuth() {
      const topActionBtn = document.getElementById('topActionBtn');
      const headerLoginBtn = document.getElementById('headerLoginBtn');
      const headerBalance = document.getElementById('headerBalance');
      const mainLoginBtn = document.getElementById('mainLoginBtn');
      const betBtn = document.getElementById('betBtn');
      const hamburgerMenuIcon = document.getElementById('hamburgerMenuIcon');

      if (currentUser) {
        // Logged In
        topActionBtn.innerText = 'Share';
        headerLoginBtn.style.display = 'none';
        hamburgerMenuIcon.style.display = 'block';
        headerBalance.style.display = 'flex';
        document.getElementById('balanceText').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
        mainLoginBtn.style.display = 'none';
        betBtn.style.display = 'block';
        
        // Update share link text
        const shareUrl = `https://swiftcrash.com/?ref=${currentUser.username}`;
        document.getElementById('referralLinkText').innerText = shareUrl;
        
        // Update social buttons
        document.getElementById('waShare').href = `https://api.whatsapp.com/send?text=Join Swiftcrash using my link: ${encodeURIComponent(shareUrl)}`;
        document.getElementById('fbShare').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
        document.getElementById('twShare').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=Join Swiftcrash!`;

        // Update Referred By
        if (currentUser.referral_code) {
           document.getElementById('referredByContainer').style.display = 'block';
           document.getElementById('referredByUsername').innerText = currentUser.referral_code;
        } else {
           document.getElementById('referredByContainer').style.display = 'none';
        }
        
        // Check notifications
        fetchNotifications();
      } else {
        // Demo Mode
        topActionBtn.innerText = 'Join Now';
        headerLoginBtn.style.display = 'block';
        hamburgerMenuIcon.style.display = 'none';
        headerBalance.style.display = 'none';
        mainLoginBtn.style.display = 'block';
        betBtn.style.display = 'none';
      }
    }

    // TOP ACTION BUTTON
    function handleTopAction() {
      if (currentUser) {
        const shareDrop = document.getElementById('shareDropdown');
        shareDrop.style.display = shareDrop.style.display === 'block' ? 'none' : 'block';
      } else {
        openAuth('signup');
      }
    }

    // POPUP LOGIC
    function openAuth(type) {
      document.getElementById('authPopup').style.display = 'flex';
      toggleAuthForm(type);
      
      if (type === 'signup') {
        const storedRef = localStorage.getItem('swiftcrash_ref');
        if (storedRef) {
          document.getElementById('signupRef').value = storedRef;
        }
      }
    }
    function closeAuth() {
      document.getElementById('authPopup').style.display = 'none';
    }
    function toggleAuthForm(type) {
      document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
      document.getElementById('signupForm').style.display = type === 'signup' ? 'block' : 'none';
      document.getElementById('forgotForm').style.display = type === 'forgot' ? 'block' : 'none';
      hideAuthErrors();
    }
    function showForgotPin() { toggleAuthForm('forgot'); }
    function hideAuthErrors() {
      document.querySelectorAll('.error-msg, .success-msg').forEach(el => el.style.display = 'none');
    }

    // API CALLS
    async function doSignup() {
      hideAuthErrors();
      const username = document.getElementById('signupUsername').value;
      const phone = document.getElementById('signupPhone').value;
      const pin = document.getElementById('signupPin').value;
      const pinConfirm = document.getElementById('signupPinConfirm').value;
      const ref = document.getElementById('signupRef').value;
      const terms = document.getElementById('termsCheck').checked;
      
      const errorEl = document.getElementById('signupError');
      const spinner = document.getElementById('signupSpinner');

      if (!username || !phone || !pin) { errorEl.innerText = "Fill all required fields"; errorEl.style.display = 'block'; return; }
      if (!phone.startsWith('07') || phone.length < 10) { errorEl.innerText = "Phone must start with 07 and be valid length"; errorEl.style.display = 'block'; return; }
      if (pin !== pinConfirm) { errorEl.innerText = "PINs do not match"; errorEl.style.display = 'block'; return; }
      if (pin.length !== 6) { errorEl.innerText = "PIN must be 6 digits"; errorEl.style.display = 'block'; return; }
      if (!terms) { errorEl.innerText = "You must agree to terms"; errorEl.style.display = 'block'; return; }

      spinner.style.display = 'block';
      try {
        const res = await fetch(`${BACKEND_URL}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, phone, pin, referralCode: ref })
        });
        const data = await res.json();
        spinner.style.display = 'none';
        
        if (data.success) {
          document.getElementById('signupSuccess').innerText = "Signup successful! Switching to login...";
          document.getElementById('signupSuccess').style.display = 'block';
          setTimeout(() => {
            document.getElementById('loginPhone').value = phone;
            toggleAuthForm('login');
          }, 1500);
        } else {
          errorEl.innerText = data.error || "Signup failed";
          errorEl.style.display = 'block';
        }
      } catch (err) {
        spinner.style.display = 'none';
        errorEl.innerText = "Network error. Try again.";
        errorEl.style.display = 'block';
      }
    }

    async function doLogin() {
      hideAuthErrors();
      const phone = document.getElementById('loginPhone').value;
      const pin = document.getElementById('loginPin').value;
      const errorEl = document.getElementById('loginError');
      const spinner = document.getElementById('loginSpinner');

      if (!phone || !pin) { errorEl.innerText = "Fill all fields"; errorEl.style.display = 'block'; return; }

      spinner.style.display = 'block';
      try {
        const res = await fetch(`${BACKEND_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, pin })
        });
        const data = await res.json();
        spinner.style.display = 'none';
        
        if (data.success) {
          currentUser = data.user;
          localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
          closeAuth();
          updateUIForAuth();
        } else {
          errorEl.innerText = data.error || "Login failed";
          errorEl.style.display = 'block';
        }
      } catch (err) {
        spinner.style.display = 'none';
        errorEl.innerText = "Network error. Try again.";
        errorEl.style.display = 'block';
      }
    }

    async function doForgotPin() {
      hideAuthErrors();
      const username = document.getElementById('forgotUsername').value;
      const errorEl = document.getElementById('forgotError');
      const successEl = document.getElementById('forgotPinDisplay');
      const spinner = document.getElementById('forgotSpinner');

      if (!username) { errorEl.innerText = "Enter username"; errorEl.style.display = 'block'; return; }

      spinner.style.display = 'block';
      try {
        const res = await fetch(`${BACKEND_URL}/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        spinner.style.display = 'none';
        
        if (data.success) {
          successEl.innerText = `Your PIN: ${data.pin}`;
          successEl.style.display = 'block';
        } else {
          errorEl.innerText = data.error || "User not found";
          errorEl.style.display = 'block';
        }
      } catch (err) {
        spinner.style.display = 'none';
        errorEl.innerText = "Network error. Try again.";
        errorEl.style.display = 'block';
      }
    }

    // WITHDRAW LOGIC
    function openWithdraw() {
      if(!currentUser) {
        showNotification("Please login first", "error");
        return;
      }
      document.getElementById('withdrawPhone').value = currentUser.phone;
      document.getElementById('withdrawCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
      document.getElementById('withdrawPopup').style.display = 'flex';
      document.getElementById('withdrawSuccess').style.display = 'none';
      document.getElementById('withdrawError').style.display = 'none';
    }

    async function submitWithdraw() {
      const amount = document.getElementById('withdrawAmount').value;
      const errorEl = document.getElementById('withdrawError');
      const successEl = document.getElementById('withdrawSuccess');
      const spinner = document.getElementById('withdrawSpinner');
      const btn = document.getElementById('submitWithdrawBtn');

      if (amount < 100) { errorEl.innerText = "Min withdrawal is KSH 100"; errorEl.style.display = 'block'; return; }
      if (parseFloat(amount) > parseFloat(currentUser.balance)) { errorEl.innerText = "Insufficient balance"; errorEl.style.display = 'block'; return; }

      errorEl.style.display = 'none';
      spinner.style.display = 'block';
      btn.style.display = 'none';

      try {
        const res = await fetch(`${BACKEND_URL}/withdraw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone, amount })
        });
        const data = await res.json();
        spinner.style.display = 'none';

        if (data.success) {
          currentUser.balance = parseFloat(data.balance);
          localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
          updateUIForAuth();
          
          playSound('deposit'); // You can reuse the deposit sound or make a new one
          successEl.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span style="margin-top:10px;">Withdrawal successful! Balance updated.</span></div>`;
          document.getElementById('withdrawCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
          document.getElementById('balanceText').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
          showNotification("Withdrawal successful!", "success");
          
          setTimeout(() => {
            document.getElementById('withdrawPopup').style.display = 'none';
            btn.style.display = 'block';
            successEl.innerHTML = '';
          }, 2000);
        } else {
          errorEl.innerText = data.error || "Withdrawal failed";
          errorEl.style.display = 'block';
          btn.style.display = 'block';
          showNotification(data.error || "Withdrawal failed", "error");
        }
      } catch (err) {
        spinner.style.display = 'none';
        errorEl.innerText = "Network error. Try again.";
        errorEl.style.display = 'block';
        btn.style.display = 'block';
        showNotification("Network error. Try again.", "error");
      }
    }

    // DEPOSIT LOGIC
    function openDeposit() {
      if(!currentUser) return;
      document.getElementById('depositPhone').value = currentUser.phone;
      document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
      document.getElementById('depositPopup').style.display = 'flex';
      document.getElementById('depositSuccess').style.display = 'none';
      document.getElementById('depositError').style.display = 'none';
    }

    async function submitDeposit() {
      const amount = document.getElementById('depositAmount').value;
      const errorEl = document.getElementById('depositError');
      const successEl = document.getElementById('depositSuccess');
      const spinner = document.getElementById('depositSpinner');
      const btn = document.getElementById('submitDepositBtn');

      if (amount < 1) { errorEl.innerText = "Min deposit is KSH 1"; errorEl.style.display = 'block'; return; }

      errorEl.style.display = 'none';
      spinner.style.display = 'block';
      btn.style.display = 'none';

      try {
        const res = await fetch(`${BACKEND_URL}/pay`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone, amount })
        });
        const data = await res.json();
        spinner.style.display = 'none';
        
        if (data.success) {
          successEl.innerHTML = `STK sent. Waiting for payment confirmation... <span class="spinner" style="display:inline-block; width:15px; height:15px; margin:0 0 -3px 5px; border-width:2px;"></span>`;
          successEl.style.display = 'block';

          const reference = data.reference;

          // Poll receipt status every 4 seconds
          const checkInterval = setInterval(async () => {
            try {
              const receiptRes = await fetch(`${BACKEND_URL}/receipt/${reference}`);
              const receiptData = await receiptRes.json();

              if (receiptData.success) {
                const status = receiptData.receipt.status;

                if (status === "success" || status === "processing") {
                  clearInterval(checkInterval);

                  // Update UI immediately if we already know it's a success
                  currentUser.balance = parseFloat(currentUser.balance) + parseFloat(amount);
                  localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
                  updateUIForAuth();
                  document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
                  
                  successEl.innerHTML = `Payment confirmed ‚úÖ Updating balance... <span class="spinner" style="display:inline-block; width:15px; height:15px; margin:0 0 -3px 5px; border-width:2px;"></span>`;
                  
                  // Force refresh from database server until balance increases
                  const oldBalance = currentUser.balance - parseFloat(amount);
                  let attempts = 0;
                  const checkBalanceAndUpdate = async () => {
                     attempts++;
                     await refreshBalanceSilently();
                     if (currentUser.balance > oldBalance || attempts > 60) {
                        clearInterval(balancePoll);
                        if (currentUser.balance > oldBalance) {
                           playSound('deposit');
                           successEl.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span style="margin-top:10px;">Balance updated successfully!</span></div>`;
                           document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
                           document.getElementById('balanceText').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
                           setTimeout(() => {
                              document.getElementById('depositPopup').style.display = 'none';
                              btn.style.display = 'block';
                           }, 1000);
                        } else {
                           successEl.innerHTML = "Taking longer than usual. Balance will update shortly.";
                           setTimeout(() => {
                              document.getElementById('depositPopup').style.display = 'none';
                              btn.style.display = 'block';
                           }, 1500);
                        }
                     }
                  };
                  const balancePoll = setInterval(checkBalanceAndUpdate, 1000);
                  checkBalanceAndUpdate(); // Check immediately

                }

                if (status === "cancelled" || status === "error" || status === "stk_failed") {
                  clearInterval(checkInterval);
                  errorEl.innerText = "Payment failed or cancelled.";
                  errorEl.style.display = 'block';
                  btn.style.display = 'block';
                  successEl.style.display = 'none';
                }
              }
            } catch (e) {
              console.log("Waiting for callback confirmation...");
            }
          }, 4000);
        } else {
          errorEl.innerText = "Failed: " + (data.error || "Could not send STK Push");
          errorEl.style.display = 'block';
          btn.style.display = 'block';
          successEl.style.display = 'none';
        }
      } catch(err) {
        spinner.style.display = 'none';
        errorEl.innerText = "Network error connecting to payment gateway";
        errorEl.style.display = 'block';
        btn.style.display = 'block';
        successEl.style.display = 'none';
      }
    }

    async function refreshBalanceSilently() {
      if (!currentUser) return;

      try {
        const res = await fetch(`${BACKEND_URL}/refresh-balance`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify({ phone: currentUser.phone })
        });

        const data = await res.json();

        if (data.error === 'suspended') {
          doLogout();
          showNotification("Your account has been suspended by the admin. Please contact support.", "error");
          return;
        }

        if (data.success) {
          currentUser.balance = parseFloat(data.balance);
          localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
          updateUIForAuth();
          console.log("Balance refreshed from database:", data.balance);
        }

      } catch (e) {
        console.log("Silent balance refresh failed");
      }
    }

    // GAME LOOP LOGIC
    const plane = document.getElementById('plane');
    const multDisplay = document.getElementById('multiplier');
    const flewAwayText = document.getElementById('flewAwayText');
    const betBtn = document.getElementById('betBtn');

    function startGameLoop() {
      initGameSSE();
    }

    let gameEventSource = null;
    let w = 300, h = 250; // defaults
    let pathD = '';
    
    let animationFrameId = null;
    let gameStartTime = 0;
    
    function renderFrame() {
        if (gameState !== 'RUNNING') return;
        
        let elapsedSec = (Date.now() - gameStartTime) / 1000;
        let localMultiplier = Math.max(1.00, Math.exp(0.08 * elapsedSec));
        
        // Sync with server if we lag behind
        if (localMultiplier < currentMultiplier) localMultiplier = currentMultiplier;
        
        multDisplay.innerText = localMultiplier.toFixed(2) + 'x';
        
        let maxMult = 10;
        let t = Math.min(1, Math.log(localMultiplier) / Math.log(maxMult)); 
        let x = 20 + t * (w - 70);
        let y = (h - 20) - Math.pow(t, 0.7) * (h - 70);
        
        let nextT = Math.min(1, Math.log(localMultiplier + 0.1) / Math.log(maxMult));
        let nextX = 20 + nextT * (w - 70);
        let nextY = (h - 20) - Math.pow(nextT, 0.7) * (h - 70);
        let angle = Math.atan2(nextY - y, nextX - x) * 180 / Math.PI;

        plane.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
        
        pathD += ` L ${x} ${y}`;
        if(document.getElementById('trailPath')) document.getElementById('trailPath').setAttribute('d', pathD);
        
        if (betStatus === 'ACTIVE' && document.getElementById('autoSwitch').checked) {
           const autoVal = parseFloat(document.getElementById('autoCashoutVal').value);
           if (localMultiplier >= autoVal) {
             betStatus = 'CASHOUT';
             updateBetBtn('WAITING_CASHOUT');
             playSound('cashout');
             showNotification(`Auto Cashed out ${autoVal.toFixed(2)}x!`, 'success');
             setTimeout(refreshBalanceSilently, 1000);
           }
        }

        animationFrameId = requestAnimationFrame(renderFrame);
    }
    
    function initGameSSE() {
       if (gameEventSource) return;
       gameEventSource = new EventSource(`${BACKEND_URL}/api/stream`);
       
       gameEventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          
          if (data.history && data.history.length > 0) {
             const hist = document.getElementById('oddsHistory');
             hist.innerHTML = '';
             // History from server is newest first. addHistory prepends, so we reverse it to maintain order
             [...data.history].reverse().forEach(val => addHistory(val));
          }
          
          if (data.status === 'WAITING') {
             if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
             }
             gameState = 'WAITING';
             multDisplay.style.display = 'none';
             flewAwayText.style.display = 'none';
             plane.style.display = 'none';
             if(document.getElementById('trailSvg')) document.getElementById('trailSvg').style.display = 'none';
             
             const countdownContainer = document.getElementById('countdownDisplay');
             const countdownTimer = document.getElementById('countdownTimer');
             const progressFill = document.getElementById('nextRoundFill');
             if(countdownContainer) countdownContainer.style.display = 'block';
             
             if(betStatus === 'PLACED' || betStatus === 'PLACED_WAITING') {
                 betStatus = 'PLACED';
                 updateBetBtn('CANCEL');
             } else {
                 updateBetBtn('BET');
             }
             
             if (data.time !== undefined && countdownTimer) {
                countdownTimer.innerText = data.time;
                if(progressFill) {
                   progressFill.style.transition = 'none';
                   progressFill.style.width = ((data.time / 6) * 100) + '%';
                }
             }

             if (data.time === 5 && betStatus === 'NONE') {
                const autoBetEnabled = document.getElementById('autoBetSwitch') && document.getElementById('autoBetSwitch').checked;
                if(autoBetEnabled && currentUser) {
                   const amount = document.getElementById('betAmount').value;
                   if(currentUser.balance >= parseFloat(amount)) {
                      handleBetClick(); // Places bet automatically
                   }
                }
             }
             pathD = '';
          }
          else if (data.status === 'RUNNING') {
             if (gameState !== 'RUNNING') {
                playSound('fly');
                gameState = 'RUNNING';
                gameStartTime = Date.now(); // Start local timer
                
                multDisplay.style.display = 'block';
                plane.style.display = 'block';
                if(document.getElementById('trailSvg')) document.getElementById('trailSvg').style.display = 'block';
                multDisplay.style.color = 'white';
                
                const box = document.getElementById('aviatorBox');
                w = box.clientWidth || 300;
                h = box.clientHeight || 250;
                pathD = `M 20 ${h - 20}`;
                
                const countdownContainer = document.getElementById('countdownDisplay');
                if(countdownContainer) countdownContainer.style.display = 'none';
                
                if (betStatus === 'PLACED') {
                   betStatus = 'ACTIVE';
                   updateBetBtn('CASHOUT');
                   refreshBalanceSilently(); // Fetch deducted balance
                } else if (betStatus === 'NONE' || betStatus === 'CASHOUT') {
                   updateBetBtnDisabled(true);
                }
                
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(renderFrame);
             }
             
             currentMultiplier = data.multiplier; // Sync from server
             if (betStatus === 'ACTIVE') updateBetBtn('CASHOUT'); // update cashout amount display
          }
          else if (data.status === 'CRASHED') {
             if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
             }
             if (gameState !== 'CRASHED') {
                playSound('crash');
             }
             gameState = 'CRASHED';
             currentMultiplier = data.multiplier;
             multDisplay.innerText = currentMultiplier.toFixed(2) + 'x';
             multDisplay.style.color = '#ef4444';
             flewAwayText.style.display = 'block';
             plane.style.display = 'none';
             
             if (betStatus === 'ACTIVE' || betStatus === 'PROCESSING') {
                betStatus = 'NONE';
                currentBetId = null;
             } else if (betStatus === 'CASHOUT') {
                betStatus = 'NONE';
                currentBetId = null;
             }
             
             if (betStatus === 'PLACED_WAITING') {
                updateBetBtn('CANCEL_WAITING');
             } else {
                updateBetBtn('BET');
             }
          }
       };
    }

    async function placeServerBet(amount) {
      if (!currentUser || currentUser.balance < amount) {
         showNotification('Insufficient balance', 'error');
         betStatus = 'NONE';
         updateBetBtn('BET');
         return;
      }
      betStatus = 'PROCESSING';
      updateBetBtn('PROCESSING_BET');
      
      const isAuto = document.getElementById('autoSwitch') && document.getElementById('autoSwitch').checked;
      const autoVal = isAuto ? parseFloat(document.getElementById('autoCashoutVal').value) : null;
      
      try {
         const res = await fetch(`${BACKEND_URL}/bet`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: currentUser.phone, amount: amount, autoCashout: autoVal})
         });
         const data = await res.json();
         if (data.success) {
            playSound('bet');
            currentUser.balance = data.balance;
            currentBetId = data.betId;
            localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
            updateUIForAuth();
            if (gameState === 'WAITING') {
               betStatus = 'PLACED';
               updateBetBtn('CANCEL');
            } else {
               betStatus = 'PLACED_WAITING';
               updateBetBtn('CANCEL_WAITING');
            }
         } else {
            showNotification("Bet failed: " + data.error, "error");
            betStatus = 'NONE';
            updateBetBtn('BET');
         }
      } catch (e) {
         showNotification("Network error. Try again.", "error");
         betStatus = 'NONE';
         updateBetBtn('BET');
      }
    }

    async function cancelServerBet() {
      if (!currentBetId) return;
      betStatus = 'PROCESSING';
      updateBetBtn('PROCESSING_CANCEL');
      try {
         const res = await fetch(`${BACKEND_URL}/cancel_bet`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: currentUser.phone, betId: currentBetId})
         });
         const data = await res.json();
         if (data.success) {
            currentUser.balance = data.balance;
            currentBetId = null;
            localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
            updateUIForAuth();
            betStatus = 'NONE';
            updateBetBtn('BET');
         } else {
            showNotification("Cancel failed: " + data.error, "error");
            betStatus = 'PLACED';
            updateBetBtn('CANCEL');
         }
      } catch (e) {
         showNotification("Network error. Try again.", "error");
         betStatus = 'PLACED';
         updateBetBtn('CANCEL');
      }
    }

    function handleBetClick() {
      if (!currentUser) { openAuth('login'); return; }
      
      const amt = parseFloat(document.getElementById('betAmount').value);

      if (gameState === 'WAITING') {
        if (betStatus === 'NONE') {
          if(amt < 1) { alert('Min bet is 1'); return; }
          activeBetAmount = amt;
          placeServerBet(amt);
        } else if (betStatus === 'PLACED') {
          cancelServerBet();
        } else if (betStatus === 'PLACED_WAITING') {
          cancelServerBet();
        }
      } else if (gameState === 'RUNNING' || gameState === 'CRASHED') {
        if (betStatus === 'NONE') {
          if(amt < 1) { alert('Min bet is 1'); return; }
          activeBetAmount = amt;
          // Place bet for next round immediately
          placeServerBet(amt);
        } else if (betStatus === 'PLACED_WAITING') {
          // Cancel the pending bet
          cancelServerBet();
        } else if (betStatus === 'ACTIVE') {
          performCashout();
        }
      }
    }

    async function performCashout() {
      if (betStatus !== 'ACTIVE') return;
      const winAmount = activeBetAmount * currentMultiplier;
      const cashoutMult = currentMultiplier;
      const betIdToCashout = currentBetId;
      betStatus = 'CASHOUT';
      currentBetId = null;
      playSound('cashout');
      updateBetBtn('WAITING_CASHOUT'); 
      showNotification(`Cashed out ${cashoutMult.toFixed(2)}x ! Won KSH ${winAmount.toFixed(2)}`, 'success');
      
      try {
        const res = await fetch(`${BACKEND_URL}/cashout`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify({phone: currentUser.phone, amount: winAmount, multiplier: cashoutMult.toFixed(2), betId: betIdToCashout})
        });
        const data = await res.json();
        if (data.success) {
           currentUser.balance = data.balance;
           localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
           updateUIForAuth();
        }
      } catch (e) {
         console.error("Cashout update failed");
      }
    }

    function updateBetBtn(type) {
      betBtn.className = 'btn-big-bet';
      betBtn.disabled = false;
      betBtn.style.opacity = '1';
      betBtn.style.cursor = 'pointer';
      
      if (type === 'BET') {
        betBtn.innerText = gameState === 'WAITING' ? 'BET' : 'BET (NEXT ROUND)';
        betBtn.style.background = '#22c55e';
        betBtn.style.color = 'white';
      } else if (type === 'CANCEL') {
        betBtn.innerText = 'CANCEL';
        betBtn.style.background = '#ef4444';
        betBtn.style.color = 'white';
      } else if (type === 'CANCEL_WAITING') {
        betBtn.innerText = 'CANCEL (NEXT ROUND)';
        betBtn.style.background = '#ef4444';
        betBtn.style.color = 'white';
      } else if (type === 'CASHOUT') {
        betBtn.innerText = `CASHOUT ${(activeBetAmount * currentMultiplier).toFixed(2)}`;
        betBtn.style.background = '#eab308';
        betBtn.style.color = '#000';
      } else if (type === 'PROCESSING_BET') {
        betBtn.innerText = 'WAITING...';
        betBtn.style.background = '#22c55e';
        betBtn.style.color = 'white';
        betBtn.style.opacity = '0.7';
        betBtn.disabled = true;
        betBtn.style.cursor = 'not-allowed';
      } else if (type === 'PROCESSING_CANCEL') {
        betBtn.innerText = 'WAITING...';
        betBtn.style.background = '#ef4444';
        betBtn.style.color = 'white';
        betBtn.style.opacity = '0.7';
        betBtn.disabled = true;
        betBtn.style.cursor = 'not-allowed';
      } else if (type === 'WAITING_CASHOUT') {
        betBtn.innerText = 'CASHED OUT';
        betBtn.style.background = '#374151';
        betBtn.style.color = '#9ca3af';
        betBtn.style.opacity = '0.7';
        betBtn.disabled = true;
        betBtn.style.cursor = 'not-allowed';
      }
    }
    
    function updateBetBtnDisabled(disabled) {
       if (disabled) {
         betBtn.disabled = true;
         betBtn.style.opacity = '0.7';
         betBtn.style.cursor = 'not-allowed';
       } else {
         betBtn.disabled = false;
         betBtn.style.opacity = '1';
         betBtn.style.cursor = 'pointer';
       }
    }

    function setBetMode(mode) {
      const tabManual = document.getElementById('tabManual');
      const tabAuto = document.getElementById('tabAuto');
      const autoSettings = document.getElementById('autoSettingsGroup');
      
      if(mode === 'manual') {
        tabManual.classList.add('active');
        tabAuto.classList.remove('active');
        autoSettings.style.display = 'none';
      } else {
        tabManual.classList.remove('active');
        tabAuto.classList.add('active');
        autoSettings.style.display = 'flex';
      }
    }

    function updateBetButtonAmount() {
      const val = parseFloat(document.getElementById('betAmount').value) || 0;
      const btnAmt = document.getElementById('betBtnAmount');
      if (btnAmt) btnAmt.innerText = val.toFixed(2) + ' KES';
    }

    function adjustBet(val) {
      let input = document.getElementById('betAmount');
      let currentVal = parseFloat(input.value);
      if (isNaN(currentVal)) currentVal = 0;
      
      let newVal = currentVal + val;
      if(newVal < 1) newVal = 1;
      if(newVal > 100000) newVal = 100000;
      
      input.value = newVal.toFixed(2);
      updateBetButtonAmount();
    }
    function setBet(val) { 
      document.getElementById('betAmount').value = parseFloat(val).toFixed(2);
      updateBetButtonAmount();
    }

    function validateUsername() {
      const el = document.getElementById('signupUsername');
      const msg = document.getElementById('usernameValMsg');
      const valid = /^[a-zA-Z0-9_]+$/.test(el.value);
      if(!valid && el.value.length > 0) msg.style.display = 'block';
      else msg.style.display = 'none';
    }

    function copyReferral() {
       navigator.clipboard.writeText(document.getElementById('referralLinkText').innerText);
       alert("Copied!");
    }

    function addHistory(val) {
      const hist = document.getElementById('oddsHistory');
      const div = document.createElement('div');
      div.className = 'odd';
      div.innerText = val;
      let num = parseFloat(val);
      if(num < 2) div.style.color = '#ef4444';
      else if(num < 10) div.style.color = '#22c55e'; // Green for higher crash
      else div.style.color = '#eab308'; // Gold for very high crash
      hist.prepend(div);
      if(hist.children.length > 15) hist.removeChild(hist.lastChild);
    }

    // Admin scripts
    function showAdminSection(sec) {
       document.getElementById('admin-stats').style.display = (sec==='stats') ? 'block' : 'none';
       document.getElementById('admin-users').style.display = (sec==='users') ? 'block' : 'none';
       document.getElementById('admin-tx').style.display = (sec==='tx') ? 'block' : 'none';
       document.getElementById('admin-game').style.display = (sec==='game') ? 'block' : 'none';
       document.getElementById('admin-notifications').style.display = (sec==='notifications') ? 'block' : 'none';
       document.getElementById('admin-adjust').style.display = (sec==='adjust') ? 'block' : 'none';
       if(document.getElementById('admin-create')) document.getElementById('admin-create').style.display = (sec==='create') ? 'block' : 'none';
       if(sec==='users') loadAdminUsers();
       if(sec==='tx') loadAdminTx();
    }

    async function adminCreateAccount() {
       const phone = document.getElementById('adminCreatePhone').value;
       const username = document.getElementById('adminCreateUser').value;
       const pin = document.getElementById('adminCreatePin').value;
       const balance = parseFloat(document.getElementById('adminCreateBal').value);
       
       if(!phone || !username || !pin || isNaN(balance)) {
           alert("Please fill in all fields to create an account.");
           return;
       }
       try {
           const res = await fetch(`${BACKEND_URL}/admin/create-user`, {
               method: 'POST',
               headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
               body: JSON.stringify({phone, username, pin, balance})
           });
           const data = await res.json();
           if(data.success) {
               alert("User account created successfully!");
               document.getElementById('adminCreatePhone').value = '';
               document.getElementById('adminCreateUser').value = '';
               document.getElementById('adminCreatePin').value = '';
               document.getElementById('adminCreateBal').value = '0';
           } else {
               alert("Failed to create user: " + (data.error || "Unknown error"));
           }
       } catch(e) {
           alert("Error creating account: " + e.message);
       }
    }
    
    async function adminAdjustByPhone() {
       const phone = document.getElementById('adminAdjustPhone').value;
       const amt = parseFloat(document.getElementById('adminAdjustAmount').value);
       if(!phone || isNaN(amt)) {
         alert("Please enter a valid phone number and amount.");
         return;
       }
       try {
         const res = await fetch(`${BACKEND_URL}/admin/users/adjust-by-phone`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
           body: JSON.stringify({phone: phone, amount: amt})
         });
         const data = await res.json();
         if(data.success) {
            alert("Balance adjusted successfully!");
            document.getElementById('adminAdjustPhone').value = '';
            document.getElementById('adminAdjustAmount').value = '';
         } else {
            alert("Failed to adjust balance: " + (data.error || "Unknown error"));
         }
       } catch(e) {
         alert("Action failed");
       }
    }
    
    document.getElementById('adminNotifTarget').addEventListener('change', function() {
       document.getElementById('adminNotifPhoneGroup').style.display = (this.value === 'specific') ? 'block' : 'none';
    });
    
    async function loadAdminUsers() {
       try {
         const res = await fetch(`${BACKEND_URL}/admin/users`, {headers: {'Authorization': adminPwd}});
         const data = await res.json();
         if(data.success) {
            const tb = document.getElementById('adminUsersTbody');
            tb.innerHTML = '';
            data.users.forEach(u => {
               tb.innerHTML += `<tr style="border-bottom:1px solid #374151;">
                 <td>${u.username}<br><small>${u.status}</small></td>
                 <td>${u.phone}</td>
                 <td>${u.pin}</td>
                 <td>KSH ${parseFloat(u.balance).toFixed(2)}</td>
                 <td>
                   <button onclick="adminUserAction('adjust', ${u.id})" style="padding:2px 5px; font-size:10px; background:#eab308; border:none; cursor:pointer;">¬±Bal</button>
                   <button onclick="adminUserAction('${u.status==='active'?'suspend':'activate'}', ${u.id})" style="padding:2px 5px; font-size:10px; background:#f97316; border:none; cursor:pointer;">${u.status==='active'?'Susp':'Act'}</button>
                   <button onclick="adminUserAction('delete', ${u.id})" style="padding:2px 5px; font-size:10px; background:#ef4444; border:none; cursor:pointer;">Del</button>
                 </td>
               </tr>`;
            });
         }
       } catch(e) {}
    }

    async function loadAdminTx() {
       try {
         const res = await fetch(`${BACKEND_URL}/admin/transactions`, {headers: {'Authorization': adminPwd}});
         const data = await res.json();
         if(data.success) {
            const tb = document.getElementById('adminTxTbody');
            tb.innerHTML = '';
            data.transactions.forEach(t => {
               tb.innerHTML += `<tr style="border-bottom:1px solid #374151;">
                 <td>${t.phone}</td>
                 <td>${t.type}</td>
                 <td>${parseFloat(t.amount).toFixed(2)}</td>
                 <td>${t.status}</td>
               </tr>`;
            });
         }
       } catch(e) {}
    }

    async function adminUserAction(action, userId) {
       let amt = 0;
       if(action === 'adjust') {
          let p = prompt("Enter amount to add/subtract (e.g. 50 or -50)");
          if(!p) return;
          amt = parseFloat(p);
       } else if (action === 'delete') {
          if(!confirm("Are you sure you want to delete this user?")) return;
       }
       
       try {
         await fetch(`${BACKEND_URL}/admin/users/action`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
           body: JSON.stringify({action, userId, amount: amt})
         });
         loadAdminUsers();
       } catch(e) { alert("Action failed"); }
    }

    async function adminSetOdd() {
       const mult = document.getElementById('adminNextOdd').value;
       try {
         const res = await fetch(`${BACKEND_URL}/admin/set-odds`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
           body: JSON.stringify({multiplier: mult})
         });
         const data = await res.json();
         if(data.success) {
            alert("Next odds set successfully!");
            document.getElementById('adminNextOdd').value = '';
         } else alert("Failed to set odds");
       } catch(e) { alert("Error setting odds"); }
    }

    async function adminSetBounds() {
       const min = document.getElementById('adminMinOdd').value;
       const max = document.getElementById('adminMaxOdd').value;
       try {
         const res = await fetch(`${BACKEND_URL}/admin/set-bounds`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
           body: JSON.stringify({min: min, max: max})
         });
         const data = await res.json();
         if(data.success) {
            alert("Odds boundaries set successfully!");
            document.getElementById('adminMinOdd').value = '';
            document.getElementById('adminMaxOdd').value = '';
         } else alert("Failed to set boundaries");
       } catch(e) { alert("Error setting boundaries"); }
    }
    
    async function adminSendNotification() {
       const target = document.getElementById('adminNotifTarget').value;
       const phone = document.getElementById('adminNotifPhone').value;
       const message = document.getElementById('adminNotifMessage').value;
       
       if(!message) { alert("Enter a message"); return; }
       if(target === 'specific' && !phone) { alert("Enter phone number"); return; }
       
       try {
         const res = await fetch(`${BACKEND_URL}/admin/send-notification`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json', 'Authorization': adminPwd},
           body: JSON.stringify({target, phone, message})
         });
         const data = await res.json();
         if(data.success) {
            alert(`Notification sent to ${data.count} user(s)!`);
            document.getElementById('adminNotifMessage').value = '';
         } else alert("Failed to send notification");
       } catch(e) { alert("Error sending notification"); }
    }
    
    // NOTIFICATION FUNCTIONS
    async function fetchNotifications() {
       if(!currentUser) return;
       try {
         const res = await fetch(`${BACKEND_URL}/api/notifications?phone=${currentUser.phone}`);
         const data = await res.json();
         if(data.success) {
            const unreadCount = data.notifications.filter(n => !n.is_read).length;
            const badge = document.getElementById('notificationBadge');
            if(unreadCount > 0) {
               badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
               badge.style.display = 'flex';
            } else {
               badge.style.display = 'none';
            }
            return data.notifications;
         }
       } catch(e) {
          console.log("Failed to fetch notifications");
       }
       return [];
    }
    
    async function openNotifications() {
       document.getElementById('notificationsPopup').style.display = 'flex';
       const notifications = await fetchNotifications();
       const list = document.getElementById('notificationsList');
       
       if(notifications.length === 0) {
          list.innerHTML = '<p style="text-align:center; color:#9ca3af;">No notifications yet</p>';
       } else {
          list.innerHTML = '';
          notifications.forEach(n => {
             const div = document.createElement('div');
             div.className = 'notification-item' + (n.is_read ? '' : ' unread');
             div.innerHTML = `
               <div>${n.message}</div>
               <div class="notification-time">${new Date(n.created_at).toLocaleString()}</div>
             `;
             list.appendChild(div);
          });
       }
    }
    
    function closeNotifications() {
       document.getElementById('notificationsPopup').style.display = 'none';
    }
    
    async function markAllAsRead() {
       if(!currentUser) return;
       try {
         await fetch(`${BACKEND_URL}/api/notifications/mark-read`, {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify({phone: currentUser.phone})
         });
         await fetchNotifications();
         openNotifications();
       } catch(e) {
          console.log("Failed to mark as read");
       }
    }

    let adminPwd = '';
    async function doAdminLogin() {
      adminPwd = document.getElementById('adminPassword').value;
      try {
        const res = await fetch(`${BACKEND_URL}/admin/stats`, {
           headers: { 'Authorization': adminPwd }
        });
        const data = await res.json();
        if(data.success) {
          document.getElementById('adminLogin').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          document.getElementById('statUsers').innerText = data.users;
          document.getElementById('statBalance').innerText = 'KSH ' + parseFloat(data.balance).toFixed(2);
          document.getElementById('statBets').innerText = data.bets;
        } else {
          alert("Invalid admin password");
        }
      } catch (e) {
        alert("Error fetching admin stats");
      }
    }
    function openAdmin() {
      document.getElementById('adminPopup').style.display = 'flex';
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }
  </script>
</body>
</html>
