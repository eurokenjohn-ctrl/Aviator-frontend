<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swiftcrash - My Account / Menu</title>
  <style>
    body { background-color: #09090b; color: white; font-family: sans-serif; margin: 0; padding-bottom: 80px; }
    
    /* Header */
    .header { padding: 15px; display: flex; justify-content: flex-start; gap: 15px; align-items: center; border-bottom: 1px solid #1f2937; background: #111827; position: sticky; top: 0; z-index: 100; }
    .header-btn { background: #1f2937; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .header-title { margin: 0; font-size: 18px; flex: 1; text-align: center; }
    .notification-bell { display: block; position: relative; cursor: pointer; }
    .notification-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    
    /* Content Padding */
    .content { padding: 15px; }

    /* Cards */
    .card { background: #111827; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #1f2937; }
    .card-title { font-size: 12px; color: #9ca3af; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
    
    /* Buttons */
    .btn-deposit { flex: 1; background: #22c55e; color: white; padding: 12px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; }
    .btn-withdraw { flex: 1; background: #f59e0b; color: white; padding: 12px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; }

    /* List Items */
    .list-container { background: #111827; border-radius: 12px; border: 1px solid #1f2937; overflow: hidden; margin-bottom: 15px; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #1f2937; cursor: pointer; }
    .list-item:last-child { border-bottom: none; }
    .list-item-content { display: flex; align-items: center; gap: 15px; font-weight: 500; font-size: 14px; }
    .list-arrow { color: #9ca3af; }

    /* Communication Cards */
    .comm-cards { display: flex; gap: 10px; margin-bottom: 15px; }
    .comm-btn { flex: 1; padding: 15px; border-radius: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; color: white; font-size: 14px; }
    .comm-whatsapp { background: #22c55e; }
    .comm-call { background: #111827; border: 1px solid #1f2937; }

    /* Social Media */
    .social-row { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
    .social-btn { flex: 1; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: white; text-decoration: none; font-weight: bold; font-size: 14px; }
    .social-ig { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
    .social-fb { background: #1877F2; }
    .social-x { background: #000; border: 1px solid #333; }
    .social-tk { background: #000; border: 1px solid #333; }
    .social-yt { background: #FF0000; }

    /* Info Boxes */
    .info-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .info-box { flex: 1; background: #111827; border-radius: 12px; border: 1px solid #1f2937; padding: 15px; }
    .info-label { font-size: 10px; color: #9ca3af; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
    .info-value { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
    
    /* Footer */
    .footer { position: fixed; bottom: 0; width: 100%; background: #111827; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #1f2937; z-index: 10; }
    .footer a { color: #9ca3af; text-decoration: none; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .footer a.active { color: #facc15; }
    .footer .center-btn { background: #facc15; border-radius: 50%; width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; color: #000; margin-top: -24px; box-shadow: 0 -4px 10px rgba(250, 204, 21, 0.3); }

  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <button class="header-btn" onclick="window.location.href='index.html'">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
    </button>
    <h2 class="header-title">My Account</h2>
    <div class="notification-bell" onclick="openNotifications()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <div class="notification-badge">3</div>
    </div>
  </div>

  <div class="content">
    
    <!-- Profile Info Card -->
    <div class="card">
      <h3 style="margin: 0 0 5px 0; color: #facc15; font-size: 18px;" id="userNameDisplay">Swiftcrash user</h3>
      <p style="margin: 0 0 15px 0; color: #9ca3af; font-size: 14px;" id="userPhoneDisplay">254700000000</p>
      
      <div style="font-size: 12px; color: #9ca3af; margin-bottom: 5px;">Available Balance</div>
      <div style="font-size: 28px; font-weight: bold; color: #22c55e; margin-bottom: 20px;" id="userBalanceDisplay">KSH 0.00</div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn-deposit" onclick="alert('Open Deposit Popup')">DEPOSIT</button>
        <button class="btn-withdraw" onclick="alert('Open Withdraw Popup')">WITHDRAW</button>
      </div>
    </div>

    <!-- Quick Action -->
    <div class="card-title">Quick Action</div>
    <div class="list-container">
      <div class="list-item" onclick="openTransactionHistory()">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
          Transaction history
        </div>
        <span class="list-arrow">></span>
      </div>
      <div class="list-item" onclick="openMyBets()">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          Users bets
        </div>
        <span class="list-arrow">></span>
      </div>
      <div class="list-item" onclick="openNotifications()">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
          Notifications
        </div>
        <span class="list-arrow">></span>
      </div>
      <div class="list-item" onclick="openReferralHistory()">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Refer and earn
        </div>
        <span class="list-arrow">></span>
      </div>
      <div class="list-item" onclick="window.location.href='support.html'">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Support
        </div>
        <span class="list-arrow">></span>
      </div>
      <div class="list-item" onclick="window.location.href='password.html'">
        <div class="list-item-content">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Change password
        </div>
        <span class="list-arrow">></span>
      </div>
    </div>

    <div style="text-align: center; margin-bottom: 20px;">
      <h3 style="color: #22c55e; font-size: 24px; margin: 0 0 5px 0;">Swiftcrash</h3>
      <p style="color: #9ca3af; font-size: 12px; margin: 0;">Kenya's #1 Betting Platform</p>
    </div>

    <!-- Communication Cards -->
    <div class="comm-cards">
      <a href="https://wa.me/254723308753" class="comm-btn comm-whatsapp">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21"/><path d="M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1Z"/><path d="M14 14a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-1 0v1Z"/></svg>
        WhatsApp
      </a>
      <a href="tel:254723308753" class="comm-btn comm-call">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        Call Us
      </a>
    </div>

    <!-- Accordion Menus -->
    <div class="list-container">
      <div class="list-item">
        <div class="list-item-content">Products</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      <div class="list-item">
        <div class="list-item-content">Support</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      <div class="list-item">
        <div class="list-item-content">Info</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      <div class="list-item">
        <div class="list-item-content">18+ Only</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
      </div>
    </div>

    <!-- Social Media -->
    <div class="social-row">
      <a href="#" class="social-btn social-ig">IG</a>
      <a href="#" class="social-btn social-fb">FB</a>
      <a href="#" class="social-btn social-x">X</a>
      <a href="#" class="social-btn social-tk">TK</a>
      <a href="#" class="social-btn social-yt">YT</a>
    </div>

    <!-- Info Boxes (Pay With / Age Limit) -->
    <div class="info-row">
      <div class="info-box">
        <div class="info-label">Pay With</div>
        <div class="info-value" style="color: #22c55e;">
          <span style="background: white; color: black; padding: 3px 6px; border-radius: 4px; font-size: 10px;">M-PESA</span>
          562424
        </div>
      </div>
      <div class="info-box">
        <div class="info-label">Age Limit</div>
        <div class="info-value" style="color: #ef4444;">
          <span style="background: #ef4444; color: white; padding: 3px 6px; border-radius: 4px; font-size: 10px;">18+</span>
          Adults Only
        </div>
      </div>
    </div>

    <!-- Legal Text -->
    <div style="text-align: center; font-size: 11px; color: #9ca3af; margin-bottom: 30px;">
      <h4 style="color: white; margin-bottom: 8px; font-size: 14px;">License</h4>
      <p style="line-height: 1.5;">Swiftcrash is licensed by the Betting Control and Licensing Board of Kenya (BCLB) under the Betting, Lotteries and Gaming Act, 1966, and any regulations made thereunder under License Numbers: BK-0001132 and PG-0001386.</p>
      
      <h4 style="color: white; margin-bottom: 8px; margin-top: 20px; font-size: 14px;">Responsible Gaming Policy</h4>
      <p style="line-height: 1.5;">This is a real-money gambling app. Please gamble responsibly and only bet what you can afford. For gambling addiction help and support, please contact us at <a href="tel:0715979797" style="color: #22c55e; text-decoration: none; font-weight: bold;">0715 979 797</a> or visit <a href="http://www.responsiblegambling.or.ke" style="color: #22c55e; text-decoration: none; font-weight: bold;">www.responsiblegambling.or.ke</a>.</p>
      <p style="margin-top: 20px;">© 2026 Swiftcrash Kenya</p>
    </div>

    <!-- Danger Zone -->
    <div class="card-title">Danger Zone</div>
    <div class="list-container">
      <div class="list-item" onclick="alert('Open Delete Account Popup')" style="padding: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 8px; color: #ef4444; display: flex;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
          </div>
          <div>
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 4px; font-size: 14px;">Delete Account</div>
            <div style="color: #9ca3af; font-size: 12px;">Permanently remove your data</div>
          </div>
        </div>
        <span style="color: #ef4444;">></span>
      </div>
    </div>

    <button style="width: 100%; background: #111827; border: 1px solid #1f2937; color: white; padding: 15px; border-radius: 12px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px; cursor: pointer; font-size: 14px;" onclick="alert('Signing out...')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign Out
    </button>
  </div>

  <div class="footer">
    <a href="index.html" class="active">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 12h4"/><path d="M8 10v4"/><path d="M15 13h.01"/><path d="M18 11h.01"/></svg>
      Game
    </a>
    <a href="Bets.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
      Bets
    </a>
    <a href="Wallet.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a8 8 0 0 1-5 7.96V16a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v5.96A8 8 0 0 1 2 15V7"/><path d="M22 10.5v1.07a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V10.5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z"/></svg>
      Wallet
    </a>
    <div style="position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <a href="javascript:void(0)" onclick="document.getElementById('menuDropdown').style.display = document.getElementById('menuDropdown').style.display === 'block' ? 'none' : 'block'" style="display:flex; flex-direction:column; align-items:center; color:#9ca3af; text-decoration:none; font-size:12px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 2px;"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        Menu
      </a>
      <div id="menuDropdown" style="display:none; position:absolute; bottom:50px; right:0; background:#1f2937; border:1px solid #374151; border-radius:8px; width:120px; z-index:100; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        <a href="Menu.html" style="display:flex; align-items:center; padding:12px; color:white; text-decoration:none; border-bottom:1px solid #374151; font-size:14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>Full Menu</a>
        <a href="#" onclick="openAdmin(); document.getElementById('menuDropdown').style.display='none'" style="display:flex; align-items:center; padding:12px; color:white; text-decoration:none; font-size:14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Admin</a>
      </div>
    </div>
  </div><script>
  const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
    ? 'http://localhost:3000' 
    : 'https://swiftcrash-com.onrender.com'; // Adjust to your backend URL

  let currentUser = null;

  function initMenu() {
    const userStr = localStorage.getItem('user');
    if (userStr) {
      try {
        currentUser = JSON.parse(userStr);
        document.getElementById('userNameDisplay').innerText = currentUser.username || 'Swiftcrash user';
        document.getElementById('userPhoneDisplay').innerText = currentUser.phone || '000000000';
        document.getElementById('userBalanceDisplay').innerText = 'KSH ' + parseFloat(currentUser.balance || 0).toFixed(2);
        
        fetchNotificationsCount();
        refreshBalanceSilently();
        
        setInterval(() => {
          refreshBalanceSilently();
          fetchNotificationsCount();
        }, 10000);
      } catch(e) {}
    } else {
      window.location.href = 'index.html'; // Redirect to login if not logged in
    }
  }

  async function refreshBalanceSilently() {
    if (!currentUser) return;
    try {
      const res = await fetch(`${BACKEND_URL}/refresh-balance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: currentUser.phone })
      });
      const data = await res.json();
      if (data.success) {
        currentUser.balance = parseFloat(data.balance);
        localStorage.setItem('user', JSON.stringify(currentUser));
        document.getElementById('userBalanceDisplay').innerText = 'KSH ' + parseFloat(currentUser.balance).toFixed(2);
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function fetchNotificationsCount() {
    if(!currentUser) return;
    try {
      const res = await fetch(`${BACKEND_URL}/api/notifications?phone=${currentUser.phone}`);
      const data = await res.json();
      if(data.success) {
        const unreadCount = data.notifications.filter(n => !n.is_read).length;
        const badge = document.querySelector('.notification-badge');
        if (badge) {
          badge.innerText = unreadCount;
          badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
      }
    } catch(e) {}
  }

  async function openNotifications() {
    document.getElementById('notificationsPopup').style.display = 'flex';
    const list = document.getElementById('notificationsList');
    list.innerHTML = '<p style="text-align:center; color:#9ca3af; font-size: 14px; padding: 20px 0;">Loading...</p>';
    if(!currentUser) return;
    
    try {
      const res = await fetch(`${BACKEND_URL}/api/notifications?phone=${currentUser.phone}`);
      const data = await res.json();
      if(data.success) {
        if(data.notifications.length === 0) {
          list.innerHTML = '<p style="text-align:center; color:#9ca3af;">No notifications yet</p>';
        } else {
          list.innerHTML = data.notifications.map(n => `
            <div style="background: ${n.is_read ? '#1f2937' : '#1e293b'}; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 13px; border-left: 3px solid ${n.is_read ? '#3b82f6' : '#f59e0b'};">
              ${n.message}
              <div style="font-size: 10px; color: #9ca3af; margin-top: 5px;">${new Date(n.created_at).toLocaleString()}</div>
            </div>
          `).join('');
          
          // Mark as read
          fetch(`${BACKEND_URL}/api/notifications/mark-read`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: currentUser.phone})
          });
          
          const badge = document.querySelector('.notification-badge');
          if (badge) badge.style.display = 'none';
        }
      }
    } catch(e) {
      list.innerHTML = '<p style="text-align:center; color:#ef4444;">Error loading notifications</p>';
    }
  }

  function closeNotifications() { document.getElementById('notificationsPopup').style.display = 'none'; }

  async function openTransactionHistory() {
    document.getElementById('transactionHistoryPopup').style.display = 'flex';
    const list = document.getElementById('transactionsList');
    list.innerHTML = '<p style="text-align:center; color:#9ca3af;">Loading...</p>';
    if(!currentUser) return;

    try {
      const res = await fetch(`${BACKEND_URL}/transactions-history`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: currentUser.phone })
      });
      const data = await res.json();
      if (data.success) {
        if (data.transactions.length === 0) {
           list.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:20px;">No transactions found</div>';
        } else {
           list.innerHTML = data.transactions.map(tx => `
             <div style="background:#1f2937; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border-left: 4px solid ${tx.type === 'deposit' ? '#22c55e' : (tx.type==='withdrawal' ? '#f59e0b' : '#3b82f6')}">
               <div>
                 <div style="font-weight:bold; font-size:14px; text-transform:capitalize;">${tx.type}</div>
                 <div style="font-size:11px; color:#9ca3af;">${new Date(tx.created_at).toLocaleString()}</div>
               </div>
               <div style="text-align:right;">
                 <div style="font-weight:bold; color:${tx.type === 'deposit' || tx.type === 'win' || tx.type === 'referral_bonus' ? '#22c55e' : '#f59e0b'}">
                   ${tx.type === 'deposit' || tx.type === 'win' || tx.type === 'referral_bonus' ? '+' : '-'}KSH ${parseFloat(tx.amount).toFixed(2)}
                 </div>
                 <div style="font-size:11px; color:${tx.status==='success'?'#22c55e':(tx.status==='failed'?'#ef4444':'#f59e0b')}; text-transform:capitalize;">${tx.status}</div>
               </div>
             </div>
           `).join('');
        }
      }
    } catch(e) {
      list.innerHTML = '<p style="text-align:center; color:#ef4444;">Error loading transactions</p>';
    }
  }

  function closeTransactionHistory() { document.getElementById('transactionHistoryPopup').style.display = 'none'; }

  async function openMyBets() {
    document.getElementById('myBetsPopup').style.display = 'flex';
    const list = document.getElementById('myBetsList');
    list.innerHTML = '<p style="text-align:center; color:#9ca3af;">Loading...</p>';
    if(!currentUser) return;

    try {
      const res = await fetch(`${BACKEND_URL}/api/my-bets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: currentUser.phone })
      });
      const data = await res.json();
      if (data.success) {
        if (data.bets.length === 0) {
           list.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:20px;">No bets found</div>';
        } else {
           list.innerHTML = data.bets.map(bet => `
             <div style="background:#1f2937; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border-left: 4px solid ${bet.status === 'cashed_out' ? '#22c55e' : (bet.status==='lost' ? '#ef4444' : '#f59e0b')}">
               <div>
                 <div style="font-weight:bold; font-size:14px; text-transform:capitalize;">${bet.status.replace('_', ' ')}</div>
                 <div style="font-size:11px; color:#9ca3af;">${new Date(bet.created_at).toLocaleString()}</div>
               </div>
               <div style="text-align:right;">
                 <div style="font-weight:bold; color:#fff;">Bet: KSH ${parseFloat(bet.amount).toFixed(2)}</div>
                 ${bet.status === 'cashed_out' 
                   ? `<div style="font-size:12px; color:#22c55e; font-weight:bold;">Won: KSH ${(parseFloat(bet.amount) * parseFloat(bet.multiplier)).toFixed(2)} (${bet.multiplier}x)</div>` 
                   : ''}
               </div>
             </div>
           `).join('');
        }
      }
    } catch(e) {
      list.innerHTML = '<p style="text-align:center; color:#ef4444;">Error loading bets</p>';
    }
  }

  function closeMyBets() { document.getElementById('myBetsPopup').style.display = 'none'; }

  async function openReferralHistory() {
    document.getElementById('referralHistoryPopup').style.display = 'flex';
    const list = document.getElementById('referralsList');
    list.innerHTML = '<p style="text-align:center; color:#9ca3af;">Loading...</p>';
    if(!currentUser) return;
    
    try {
      const res = await fetch(`${BACKEND_URL}/api/referrals?phone=${currentUser.phone}`);
      const data = await res.json();
      if(data.success) {
        document.getElementById('refCount').innerText = data.referrals.length;
        document.getElementById('refActive').innerText = data.active_referrals;
        document.getElementById('refEarned').innerText = data.earned_amount || (data.active_referrals * 20); // Fallback estimate
        
        if (data.referrals.length === 0) {
          list.innerHTML = '<div style="text-align:center; color:#9ca3af; font-size:12px; margin-top:20px;">No referrals yet</div>';
        } else {
          list.innerHTML = data.referrals.map(r => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#1f2937; border-radius:8px; margin-bottom:8px;">
              <div>
                <div style="color:white; font-weight:bold; font-size:14px;">${r.username}</div>
                <div style="color:#9ca3af; font-size:11px;">${new Date(r.created_at).toLocaleDateString()}</div>
              </div>
              <div style="padding:5px 10px; border-radius:4px; font-size:12px; font-weight:bold; background: ${r.status==='active' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(156, 163, 175, 0.2)'}; color: ${r.status==='active' ? '#22c55e' : '#9ca3af'};">
                ${r.status==='active' ? 'Active' : 'Pending'}
              </div>
            </div>
          `).join('');
        }
      }
    } catch(e) {
      list.innerHTML = '<p style="text-align:center; color:#ef4444;">Error loading referrals</p>';
    }
  }

  function closeReferralHistory() { document.getElementById('referralHistoryPopup').style.display = 'none'; }

  // Call initMenu when page loads
  document.addEventListener('DOMContentLoaded', initMenu);
</script>

  <!-- Toast Container -->
  <div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none;"></div>

  <!-- Notifications Popup -->
  <div class="popup-overlay" id="notificationsPopup" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;" onclick="if(event.target===this) closeNotifications()">
    <div class="popup-content" style="background: #111827; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937;">
      <span class="popup-close" style="position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold;" onclick="closeNotifications()">×</span>
      <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #374151; padding-bottom:10px;">Notifications</h3>
      <div id="notificationsList" style="max-height:350px; overflow-y:auto; padding: 15px 20px; background: #0b0f19;">
        <p style="text-align:center; color:#9ca3af; font-size: 14px; padding: 20px 0;">Loading notifications...</p>
      </div>
    </div>
  </div>

  <!-- Referral History Popup -->
  <div class="popup-overlay" id="referralHistoryPopup" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;" onclick="if(event.target===this) closeReferralHistory()">
    <div class="popup-content" style="background: #111827; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937;">
      <span class="popup-close" style="position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold;" onclick="closeReferralHistory()">×</span>
      <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #374151; padding-bottom:10px;">Referral History</h3>
      
      <div style="background: #1f2937; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between;">
        <div style="text-align: center;">
          <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Total Referrals</div>
          <div style="color: #facc15; font-size: 20px; font-weight: bold;" id="refCount">0</div>
        </div>
        <div style="text-align: center;">
          <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Active (Played)</div>
          <div style="color: #22c55e; font-size: 20px; font-weight: bold;" id="refActive">0</div>
        </div>
        <div style="text-align: center;">
          <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Earned</div>
          <div style="color: #3b82f6; font-size: 20px; font-weight: bold;" id="refEarned">0</div>
        </div>
      </div>
      
      <div id="referralsList" style="max-height: 150px; overflow-y: auto;">
        <p style="text-align:center; color:#9ca3af; font-size: 14px; padding: 20px 0;">Loading referrals...</p>
      </div>
    </div>
  </div>

  <!-- Transaction History Popup -->
  <div class="popup-overlay" id="transactionHistoryPopup" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;" onclick="if(event.target===this) closeTransactionHistory()">
    <div class="popup-content" style="background: #111827; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937;">
      <span class="popup-close" style="position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold;" onclick="closeTransactionHistory()">×</span>
      <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #374151; padding-bottom:10px;">Transaction History</h3>
      <div id="transactionsList" style="max-height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
        <p style="text-align:center; color:#9ca3af; font-size: 14px; padding: 20px 0;">Loading transactions...</p>
      </div>
    </div>
  </div>

  <!-- My Bets Popup -->
  <div class="popup-overlay" id="myBetsPopup" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;" onclick="if(event.target===this) closeMyBets()">
    <div class="popup-content" style="background: #111827; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937;">
      <span class="popup-close" style="position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold;" onclick="closeMyBets()">×</span>
      <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #374151; padding-bottom:10px;">My Bets</h3>
      <div id="myBetsList" style="max-height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
