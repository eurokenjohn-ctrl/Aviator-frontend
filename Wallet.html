<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet - Swiftcrash</title>
  <style>
    body { background-color: #09090b; color: white; font-family: sans-serif; margin: 0; padding-bottom: 80px; }
    .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f2937; background: #111827; position: sticky; top: 0; z-index: 100; }
    .logo { color: #f59e0b; font-size: 20px; font-weight: 900; display: flex; align-items: center; gap: 5px; }
    .balance { font-weight: bold; font-size: 16px; color: #22c55e; display: flex; align-items: center; gap: 5px; }
    
    .wallet-container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .wallet-card { background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .wallet-label { color: #9ca3af; font-size: 14px; margin-bottom: 5px; }
    .wallet-balance { font-size: 32px; font-weight: bold; color: #fff; margin-bottom: 20px; }
    
    .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
    .btn-wallet { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; transition: transform 0.2s; }
    .btn-wallet:active { transform: scale(0.98); }
    .btn-deposit { background: #22c55e; color: white; }
    .btn-withdraw { background: #f59e0b; color: white; }
    
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .history-container { background: #111827; border-radius: 12px; border: 1px solid #1f2937; overflow: hidden; }
    .tx-item { padding: 15px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; }
    .tx-item:last-child { border-bottom: none; }
    .tx-info h4 { margin: 0; font-size: 14px; text-transform: capitalize; }
    .tx-info p { margin: 2px 0 0 0; font-size: 11px; color: #9ca3af; }
    .tx-amount { font-weight: bold; font-size: 14px; }
    .amt-deposit { color: #22c55e; }
    .amt-withdrawal { color: #f59e0b; }
    
    .info-card { background: #1f2937; padding: 15px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #3b82f6; }
    .info-card p { margin: 5px 0; font-size: 13px; color: #d1d5db; line-height: 1.4; }

    /* Footer */
    .footer { position: fixed; bottom: 0; width: 100%; background: #111827; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #1f2937; z-index: 10; }
    .footer a { color: #9ca3af; text-decoration: none; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
    .footer a.active { color: #ef4444; }

    /* Popups - Reusing index.html logic */
    .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .popup-content { background: #18181b; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; }
    .popup-close { position: absolute; top: 10px; right: 15px; color: white; cursor: pointer; font-size: 24px; font-weight: bold; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #9ca3af; }
    .form-control { width: 100%; padding: 10px; background: #111827; border: 1px solid #374151; color: white; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { width: 100%; padding: 12px; background: #e11d48; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .preset { background: #1f2937; border: none; color: white; padding: 10px 0; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .bet-presets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
    
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
    .toast-msg { padding: 15px 20px; border-radius: 8px; font-weight: bold; font-size: 14px; text-align: center; color: white; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: auto; }
    .toast-msg.show { opacity: 1; transform: translateY(0); }
    .toast-success { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .toast-error { background: linear-gradient(135deg, #dc2626, #ef4444); }

      .error-msg { color: #ef4444; font-size: 12px; margin-top: 5px; display: none; }
      .success-msg { color: #22c55e; font-size: 14px; text-align: center; margin-top: 10px; display: none; }
      .spinner { display: none; margin: 10px auto; border: 4px solid rgba(255,255,255,0.1); border-left-color: #f97316; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <div class="header">
    <div class="logo"><span style="color:#facc15">ðŸ‘‘</span> Swift Wallet</div>
    <div class="balance">
      <span id="headerBalance">KSH 0.00</span>
    </div>
  </div>

  <div class="wallet-container" id="authenticatedContent" style="display:none;">
    <div class="wallet-card">
      <div class="wallet-label">Available Balance</div>
      <div class="wallet-balance" id="mainBalance">KSH 0.00</div>
      
      <div class="action-buttons">
        <button class="btn-wallet btn-deposit" onclick="openDeposit()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          Deposit
        </button>
        <button class="btn-wallet btn-withdraw" onclick="openWithdraw()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
          Withdraw
        </button>
      </div>
    </div>

    <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        Transaction History
      </div>
      
      <div class="tx-tabs" style="display: flex; gap: 10px; margin-bottom: 15px; background: #111827; padding: 5px; border-radius: 8px; border: 1px solid #1f2937;">
        <button class="tx-tab active" id="tab-all" onclick="filterTx('all', this)" style="flex: 1; padding: 8px; border: none; background: #374151; color: white; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">All</button>
        <button class="tx-tab" id="tab-withdrawal" onclick="filterTx('withdrawal', this)" style="flex: 1; padding: 8px; border: none; background: transparent; color: #9ca3af; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">Withdrawal</button>
        <button class="tx-tab" id="tab-deposit" onclick="filterTx('deposit', this)" style="flex: 1; padding: 8px; border: none; background: transparent; color: #9ca3af; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">Deposits</button>
      </div>
      <div class="history-container" id="txHistory">
      <p style="text-align:center; padding:20px; color:#9ca3af;">Loading transactions...</p>
    </div>

    <div class="info-card">
      <p><strong>Withdrawal Info:</strong></p>
      <p>â€¢ Minimum withdrawal: KSH 100.00</p>
      <p>â€¢ Maximum withdrawal: KSH 100,000.00 per day</p>
      <p>â€¢ Processing time: Instant to M-Pesa</p>
      <p>â€¢ 24/7 Customer support available</p>
    </div>
  </div>

  <div class="wallet-container" id="guestContent" style="display:none; text-align:center; margin-top:50px;">
    <div class="wallet-card">
      <h2 style="margin-top:0;">Access Denied</h2>
      <p style="color:#9ca3af; margin-bottom:20px;">Please login to access your wallet and transactions.</p>
      <button class="btn-submit" style="background:#3b82f6;" onclick="window.location.href='index.html'">Go to Login</button>
    </div>
  </div>

  <!-- Reusing Popups from index.html -->
  <div class="popup-overlay" id="depositPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('depositPopup').style.display='none'">Ã—</span>
      <h2 style="margin-top:0;">Deposit via M-Pesa</h2>
      <div class="form-group">
        <label>M-Pesa Number</label>
        <input type="text" class="form-control" id="depositPhone" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Amount (Min KSH 1)</label>
        <input type="number" class="form-control" id="depositAmount" value="100" min="1">
      </div>
      <div class="bet-presets">
        <button class="preset" onclick="document.getElementById('depositAmount').value=100">100</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=200">200</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=500">500</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=1000">1K</button>
        <button class="preset" onclick="document.getElementById('depositAmount').value=5000">5K</button>
      </div>
      <p style="font-size: 14px; color: #9ca3af; text-align:center;">Current Balance: <strong id="depositCurrentBalance" style="color:white;">KSH 0.00</strong></p>
        
        <div class="error-msg" id="depositError"></div>
        <div class="success-msg" id="depositSuccess"></div>
        <div class="spinner" id="depositSpinner"></div>
        <button class="btn-submit" id="submitDepositBtn" style="background:#22c55e;" onclick="submitDeposit()">Initiate Deposit</button>
    </div>
  </div>

  <div class="popup-overlay" id="withdrawPopup">
    <div class="popup-content">
      <span class="popup-close" onclick="document.getElementById('withdrawPopup').style.display='none'">Ã—</span>
      <h2 style="margin-top:0;">Withdraw to M-Pesa</h2>
      <div class="form-group">
        <label>M-Pesa Number</label>
        <input type="text" class="form-control" id="withdrawPhone" readonly style="color:#9ca3af; background:#1f2937;">
      </div>
      <div class="form-group">
        <label>Amount (Min KSH 100)</label>
        <input type="number" class="form-control" id="withdrawAmount" value="100" min="100">
      </div>
      <div class="bet-presets">
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=100">100</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=500">500</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=1000">1K</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=2000">2K</button>
        <button class="preset" onclick="document.getElementById('withdrawAmount').value=5000">5K</button>
      </div>
      <p style="font-size: 14px; color: #9ca3af; text-align:center;">Current Balance: <strong id="withdrawCurrentBalance" style="color:white;">KSH 0.00</strong></p>

        <div class="error-msg" id="withdrawError"></div>
        <div class="success-msg" id="withdrawSuccess"></div>
        <div class="spinner" id="withdrawSpinner"></div>
        <button class="btn-submit" id="submitWithdrawBtn" style="background:#f59e0b;" onclick="submitWithdraw()">Confirm Withdrawal</button>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 12h4M8 10v4M15 13h.01M18 11h.01"/></svg>
      Game
    </a>
    <a href="Bets.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4M12 16h4M8 11h.01M8 16h.01"/></svg>
      Bets
    </a>
    <a href="Wallet.html" class="active">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a8 8 0 0 1-5 7.96V16a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v5.96A8 8 0 0 1 2 15V7"/><path d="M22 10.5v1.07a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V10.5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z"/></svg>
      Wallet
    </a>
    <a href="index.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
      Menu
    </a>
  </div>

  <script>
    const BACKEND_URL = "https://swiftaviator-server.onrender.com";
    let currentUser = JSON.parse(localStorage.getItem('swiftcrash_user'));
      let allTransactions = [];
      let currentTxFilter = 'all';

      function playSound(type) {
        // Audio logic placeholder
      }

    function showNotification(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast-msg toast-${type}`;
      toast.innerText = message;
      container.appendChild(toast);
      void toast.offsetWidth;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    window.onload = async () => {
      if (!currentUser) {
        document.getElementById('guestContent').style.display = 'block';
      } else {
        document.getElementById('authenticatedContent').style.display = 'block';
        updateUI();
        await fetchTransactions();
      }
    };

    function updateUI() {
        const bal = parseFloat(currentUser.balance).toFixed(2);
        document.getElementById('headerBalance').innerText = `KSH ${bal}`;
        document.getElementById('mainBalance').innerText = `KSH ${bal}`;
      }

      function filterTx(type, btn) {
        currentTxFilter = type;
        document.querySelectorAll('.tx-tab').forEach(tab => {
          tab.style.background = 'transparent';
          tab.style.color = '#9ca3af';
        });
        if(btn) {
          btn.style.background = '#374151';
          btn.style.color = 'white';
        }
        renderTransactions();
      }

      function renderTransactions() {
        const container = document.getElementById('txHistory');
        let filtered = allTransactions;
        if (currentTxFilter !== 'all') {
          filtered = allTransactions.filter(t => t.type === currentTxFilter);
        }
        
        if (filtered.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:20px; color:#9ca3af;">No transactions found.</p>';
        } else {
          container.innerHTML = filtered.map(t => `
            <div class="tx-item">
              <div class="tx-info">
                <h4>${t.type}</h4>
                <p>${new Date(t.created_at).toLocaleString()}</p>
              </div>
              <div class="tx-amount amt-${t.type}">
                ${t.type === 'deposit' ? '+' : '-'} KSH ${parseFloat(t.amount).toFixed(2)}
              </div>
            </div>
          `).join('');
        }
      }

      async function refreshBalanceSilently() {
        if (!currentUser) return;
        try {
          const res = await fetch(`${BACKEND_URL}/refresh-balance`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            },
            body: JSON.stringify({ phone: currentUser.phone })
          });
          const data = await res.json();
          if (data.success) {
            currentUser.balance = parseFloat(data.balance);
            localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
            updateUI();
          }
        } catch (e) { console.error("Balance refresh failed"); }
      }

    async function fetchTransactions() {
      try {
        const res = await fetch(`${BACKEND_URL}/transactions-history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentUser.phone })
        });
        const data = await res.json();
        const container = document.getElementById('txHistory');
        if (data.success) {
            allTransactions = data.transactions;
            renderTransactions();
          }
      } catch (e) {
        console.error("Failed to fetch transactions");
      }
    }

    function openDeposit() {
        if(!currentUser) return;
        document.getElementById('depositPhone').value = currentUser.phone;
        document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
        document.getElementById('depositPopup').style.display = 'flex';
        document.getElementById('depositSuccess').style.display = 'none';
        document.getElementById('depositError').style.display = 'none';
        document.getElementById('depositSpinner').style.display = 'none';
        document.getElementById('submitDepositBtn').style.display = 'block';
      }

    function openWithdraw() {
        if(!currentUser) return;
        document.getElementById('withdrawPhone').value = currentUser.phone;
        document.getElementById('withdrawCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
        document.getElementById('withdrawPopup').style.display = 'flex';
        document.getElementById('withdrawSuccess').style.display = 'none';
        document.getElementById('withdrawError').style.display = 'none';
        document.getElementById('withdrawSpinner').style.display = 'none';
        document.getElementById('submitWithdrawBtn').style.display = 'block';
      }

    async function submitDeposit() {
        const amount = document.getElementById('depositAmount').value;
        const errorEl = document.getElementById('depositError');
        const successEl = document.getElementById('depositSuccess');
        const spinner = document.getElementById('depositSpinner');
        const btn = document.getElementById('submitDepositBtn');

        if (!amount || amount < 1) { errorEl.innerText = "Min deposit is KSH 1"; errorEl.style.display = 'block'; return; }

        errorEl.style.display = 'none';
        spinner.style.display = 'block';
        btn.style.display = 'none';

        try {
          const res = await fetch(`${BACKEND_URL}/pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: currentUser.phone, amount })
          });
          const data = await res.json();
          spinner.style.display = 'none';
          
          if (data.success) {
            successEl.innerHTML = `STK sent. Waiting for payment confirmation... <span class="spinner" style="display:inline-block; width:15px; height:15px; margin:0 0 -3px 5px; border-width:2px;"></span>`;
            successEl.style.display = 'block';

            const reference = data.reference;

            const checkInterval = setInterval(async () => {
              try {
                const receiptRes = await fetch(`${BACKEND_URL}/receipt/${reference}`);
                const receiptData = await receiptRes.json();

                if (receiptData.success) {
                  const status = receiptData.receipt.status;

                  if (status === "success" || status === "processing") {
                    clearInterval(checkInterval);

                    currentUser.balance = parseFloat(currentUser.balance) + parseFloat(amount);
                    localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
                    updateUI();
                    document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
                    
                    successEl.innerHTML = `Payment confirmed âœ… Updating balance... <span class="spinner" style="display:inline-block; width:15px; height:15px; margin:0 0 -3px 5px; border-width:2px;"></span>`;
                    
                    const oldBalance = currentUser.balance - parseFloat(amount);
                    let attempts = 0;
                    const checkBalanceAndUpdate = async () => {
                       attempts++;
                       await refreshBalanceSilently();
                       if (currentUser.balance > oldBalance || attempts > 60) {
                          clearInterval(balancePoll);
                          if (currentUser.balance > oldBalance) {
                             playSound('deposit');
                             successEl.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span style="margin-top:10px;">Balance updated successfully!</span></div>`;
                             document.getElementById('depositCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
                             fetchTransactions();
                             setTimeout(() => {
                                document.getElementById('depositPopup').style.display = 'none';
                                btn.style.display = 'block';
                             }, 1000);
                          } else {
                             successEl.innerHTML = "Taking longer than usual. Balance will update shortly.";
                             setTimeout(() => {
                                document.getElementById('depositPopup').style.display = 'none';
                                btn.style.display = 'block';
                             }, 1500);
                          }
                       }
                    };
                    const balancePoll = setInterval(checkBalanceAndUpdate, 1000);
                    checkBalanceAndUpdate();

                  }

                  if (status === "cancelled" || status === "error" || status === "stk_failed") {
                    clearInterval(checkInterval);
                    errorEl.innerText = "Payment failed or cancelled.";
                    errorEl.style.display = 'block';
                    btn.style.display = 'block';
                    successEl.style.display = 'none';
                  }
                }
              } catch (e) {
                console.log("Waiting for callback confirmation...");
              }
            }, 4000);
          } else {
            errorEl.innerText = "Failed: " + (data.error || "Could not send STK Push");
            errorEl.style.display = 'block';
            btn.style.display = 'block';
            successEl.style.display = 'none';
          }
        } catch(err) {
          spinner.style.display = 'none';
          errorEl.innerText = "Network error connecting to payment gateway";
          errorEl.style.display = 'block';
          btn.style.display = 'block';
        }
      }

      async function submitWithdraw() {
        const amount = document.getElementById('withdrawAmount').value;
        const errorEl = document.getElementById('withdrawError');
        const successEl = document.getElementById('withdrawSuccess');
        const spinner = document.getElementById('withdrawSpinner');
        const btn = document.getElementById('submitWithdrawBtn');

        if (!amount || amount < 100) { errorEl.innerText = "Min withdrawal is KSH 100"; errorEl.style.display = 'block'; return; }
        if (parseFloat(amount) > parseFloat(currentUser.balance)) { errorEl.innerText = "Insufficient balance"; errorEl.style.display = 'block'; return; }

        errorEl.style.display = 'none';
        spinner.style.display = 'block';
        btn.style.display = 'none';

        try {
          const res = await fetch(`${BACKEND_URL}/withdraw`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: currentUser.phone, amount })
          });
          const data = await res.json();
          spinner.style.display = 'none';

          if (data.success) {
            currentUser.balance = parseFloat(data.balance);
            localStorage.setItem('swiftcrash_user', JSON.stringify(currentUser));
            updateUI();
            fetchTransactions();
            
            playSound('deposit');
            successEl.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span style="margin-top:10px;">Withdrawal successful! Balance updated.</span></div>`;
            document.getElementById('withdrawCurrentBalance').innerText = `KSH ${parseFloat(currentUser.balance).toFixed(2)}`;
            showNotification("Withdrawal successful!", "success");
            
            setTimeout(() => {
              document.getElementById('withdrawPopup').style.display = 'none';
              btn.style.display = 'block';
              successEl.innerHTML = '';
            }, 2000);
          } else {
            errorEl.innerText = data.error || "Withdrawal failed";
            errorEl.style.display = 'block';
            btn.style.display = 'block';
            showNotification(data.error || "Withdrawal failed", "error");
          }
        } catch (err) {
          spinner.style.display = 'none';
          errorEl.innerText = "Network error. Try again.";
          errorEl.style.display = 'block';
          btn.style.display = 'block';
          showNotification("Network error. Try again.", "error");
        }
      }
    </script>
</body>
  </html>
